<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á§á”á€ášááŸáŸáŸ†áá„áŸ‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg-grad: linear-gradient(135deg, #e0e5ec 0%, #f0f4f8 100%);
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }

        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background: var(--bg-grad);
            margin: 0;
            color: #2d3748;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container { padding: 25px 15px; }

        .card-neu {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 30px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.6);
            margin-bottom: 30px;
        }

        .input-neu {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 20px;
            background: #e0e5ec;
            box-shadow: var(--inner-shadow);
            outline: none;
            font-family: inherit;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .btn-main {
            border: none;
            border-radius: 20px;
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            font-weight: 700;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .img-profile {
            width: 65px;
            height: 65px;
            border-radius: 20px;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid white;
        }

        .modal-glass {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(224, 229, 236, 0.85);
            backdrop-filter: blur(20px);
            z-index: 1000;
        }

        .modal-body { height: 100%; overflow-y: auto; padding: 30px 20px; }

        .tool-row {
            background: white;
            padding: 15px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 50px;
        }

        .btn-qty {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--primary);
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 2000; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="loader">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite;"></div>
    <p style="margin-top:15px; font-weight:600;">á€áŸ†á–á»á„ášáŸ€á”á…áŸ†...</p>
</div>

<div class="header">
    <div style="font-weight: 800; font-size: 20px; color: var(--primary);">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á§á”á€ášááŸáŸáŸ†áá„áŸ‹</div>
    <div style="background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow);">âš™ï¸</div>
</div>

<div class="container">
    <div class="card-neu">
        <input type="text" id="gName" class="input-neu" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á€áŸ’ášá»á˜á€á˜áŸ’á˜á€áš...">
        <div style="display: flex; gap: 15px;">
            <button class="btn-main" style="background:#fff; color:#444; width: 60px;" onclick="document.getElementById('gImgIn').click()">ğŸ“·</button>
            <button class="btn-main" style="flex:1;" onclick="addGroup()">+ á”á„áŸ’á€á¾áá€áŸ’ášá»á˜</button>
        </div>
        <input type="file" id="gImgIn" style="display:none" accept="image/*" onchange="compressImage(this, 'group')">
    </div>
    <div id="gList"></div>
</div>

<div id="mApp" class="modal-glass">
    <div class="modal-body">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <button class="btn-qty" onclick="closeM()">ğŸ”™</button>
            <h2 id="mTitle" style="margin:0; font-size: 22px;"></h2>
            <button class="btn-qty" onclick="delG()" style="color:#ef4444;">ğŸ—‘ï¸</button>
        </div>

        <div id="viewMode">
            <button class="btn-main" style="width:100%; background:#475569; margin-bottom: 25px;" onclick="openEdit()">âš™ï¸ ášáŸ€á”á…áŸ†á”á‰áŸ’á‡á¸á§á”á€ášááŸ</button>
            <div style="background: rgba(255,255,255,0.5); border-radius: 30px; padding: 20px; border: 1px dashed #94a3b8;">
                <h4 style="margin: 0 0 15px 0; color: #64748b;">ğŸ“Š áŸá„áŸ’ááŸá”á”á‰áŸ’á‡á¸á§á”á€ášááŸ</h4>
                <div id="sumBox"></div>
            </div>
            <button class="btn-main" style="width:100%; background: linear-gradient(135deg, #10b981, #059669); margin-top: 30px; height: 60px; font-size: 18px;" onclick="send()">ğŸš€ á•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸ</button>
        </div>

        <div id="editMode" style="display:none;">
            <div id="tGrid"></div>
            <button class="btn-main" style="width:100%; margin-top: 25px; height: 55px;" onclick="closeEdit()">âœ… ášá€áŸ’áŸá¶á‘á»á€</button>
        </div>
    </div>
    <input type="file" id="tImgIn" style="display:none" accept="image/*" onchange="compressImage(this, 'tool')">
</div>

<script>
    const TOKEN = "8224268737:AAFhspOb3OozxmKr3INkIPhXdYmDLaJVNB8";
    const G_ID = "-1003387981594";
    const A_ID = "6109968412";

    let db = [];
    let curI = null, curT = null, tempImg = "";

    const toolsMaster = [
        {n: "á˜áŸ‰á¼á‘áŸášá”á»á€á’áŸ†", e: "ğŸ”¨"}, {n: "á˜áŸ‰á¼á‘áŸášá”á»á€áá¼á…", e: "â›ï¸"}, 
        {n: "á˜áŸ‰á¼á‘áŸášá€á¶ááŸ‹á’áŸ†", e: "âš™ï¸"}, {n: "á˜áŸ‰á¼á‘áŸášá€á¶ááŸ‹áá¼á…", e: "âœ‚ï¸"},
        {n: "áŠáŸ‚á€ááŸ’á”áŸ‚á„", e: "â›“ï¸"}, {n: "áá¶áŸáŸáŸ‡", e: "ğŸ"}, 
        {n: "á”áŸ‰áŸ‚á›", e: "ğŸ¥„"}, {n: "á…á”", e: "âš’ï¸"}, 
        {n: "á€á¶áœ", e: "ğŸ§ª"}, {n: "ášáá¶", e: "ğŸªš"}, {n: "ášá‘áŸáŸ‡", e: "ğŸ›’"}
    ];

    const request = indexedDB.open("ToolMasterDB_Final", 1);
    request.onupgradeneeded = e => { e.target.result.createObjectStore("appData", { keyPath: "id" }); };
    request.onsuccess = e => { loadDB(); };

    function save() {
        const tx = request.result.transaction("appData", "readwrite");
        tx.objectStore("appData").put({ id: "mainDB", data: db });
        renderG();
    }

    function loadDB() {
        const tx = request.result.transaction("appData", "readonly");
        const get = tx.objectStore("appData").get("mainDB");
        get.onsuccess = () => { if(get.result) { db = get.result.data; renderG(); } };
    }

    function compressImage(input, type) {
        if (!input.files[0]) return;
        document.getElementById('loader').style.display = 'flex';
        const reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 500; let w = img.width, h = img.height;
                if (w > h) { if (w > max) { h *= max/w; w = max; } }
                else { if (h > max) { w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                const b64 = canvas.toDataURL('image/jpeg', 0.8);
                if(type === 'group') tempImg = b64;
                else if(type === 'tool') { db[curI].tools[curT].img = b64; renderEdit(); save(); }
                document.getElementById('loader').style.display = 'none';
            };
        };
    }

    function addGroup() {
        let n = document.getElementById('gName').value;
        if(!n) return;
        db.push({ name: n, img: tempImg, tools: toolsMaster.map(t => ({ name: t.n, emoji: t.e, qty: 0, img: "" })) });
        tempImg = ""; document.getElementById('gName').value = "";
        save();
    }

    function renderG() {
        let h = '';
        db.forEach((g, i) => {
            h += `<div class="item-card" onclick="openM(${i})">
                    <img src="${g.img || 'https://via.placeholder.com/65?text=ğŸ‘·'}" class="img-profile">
                    <div style="flex:1">
                        <div style="font-weight:700; font-size:18px;">${g.name}</div>
                        <div style="font-size:12px; color:#64748b;">á…á»á…áŠá¾á˜áŸ’á”á¸á”á¾á€á”á‰áŸ’á‡á¸á§á”á€ášááŸ</div>
                    </div>
                    <div class="btn-qty" style="width:30px; height:30px; font-size:14px;">â¯</div>
                  </div>`;
        });
        document.getElementById('gList').innerHTML = h;
    }

    function openM(i) {
        curI = i; document.getElementById('mTitle').innerText = db[i].name;
        document.getElementById('mApp').style.display = "block";
        closeEdit();
    }

    function openEdit() {
        document.getElementById('viewMode').style.display = "none";
        document.getElementById('editMode').style.display = "block";
        renderEdit();
    }

    function renderEdit() {
        let h = '';
        db[curI].tools.forEach((t, ti) => {
            h += `<div class="tool-row">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${t.img || 'https://via.placeholder.com/45?text=ğŸ“·'}" style="width:45px; height:45px; border-radius:12px; object-fit:cover;" onclick="curT=${ti}; document.getElementById('tImgIn').click()">
                        <span style="font-weight:600;">${t.emoji} ${t.name}</span>
                    </div>
                    <div class="qty-control">
                        <button class="btn-qty" onclick="change(${ti},-1)">-</button>
                        <b style="min-width:20px; text-align:center; font-size:18px;">${t.qty}</b>
                        <button class="btn-qty" onclick="change(${ti},1)">+</button>
                    </div>
                  </div>`;
        });
        document.getElementById('tGrid').innerHTML = h;
    }

    function change(ti, d) { db[curI].tools[ti].qty = Math.max(0, db[curI].tools[ti].qty + d); renderEdit(); }

    function closeEdit() {
        document.getElementById('editMode').style.display = "none";
        document.getElementById('viewMode').style.display = "block";
        let h = '', has = false;
        db[curI].tools.forEach(t => { 
            if(t.qty > 0) { 
                h += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                        <span>${t.emoji} ${t.name}</span>
                        <b style="color:var(--primary); font-size:18px;">x${t.qty}</b>
                      </div>`; 
                has = true; 
            } 
        });
        document.getElementById('sumBox').innerHTML = has ? h : '<p style="text-align:center; color:#94a3b8;">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á§á”á€ášááŸááŸ’ášá¼áœá”á¶á“áŠá€</p>';
        save();
    }

    async function send() {
        let g = db[curI], msg = `ğŸ—ï¸ *ášá”á¶á™á€á¶ášááŸá€á¶ášáŠáŸ’á‹á¶á“áŸáŸ†áá„áŸ‹*\nğŸ‘· *á€áŸ’ášá»á˜:* ${g.name}\n\n`;
        let count = 0;
        g.tools.forEach(t => { if(t.qty > 0) { msg += `${t.emoji} ${t.name}: *${t.qty}*\n`; count++; } });
        if(count === 0) return alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á…áŸ†á“á½á“á§á”á€ášááŸ!");
        document.getElementById('loader').style.display = 'flex';
        try {
            await Promise.all([
                fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${G_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`),
                fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${A_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`)
            ]);
            alert("âœ… ášá”á¶á™á€á¶ášááŸááŸ’ášá¼áœá”á¶á“á•áŸ’á‰á¾á‡áŸ„á‚á‡áŸá™!");
        } catch(e) { alert("âŒ á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾!"); }
        document.getElementById('loader').style.display = 'none';
    }

    function delG() { if(confirm("áá¾á›áŸ„á€á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á€áŸ’ášá»á˜á“áŸáŸ‡?")) { db.splice(curI, 1); save(); closeM(); } }
    function closeM() { document.getElementById('mApp').style.display = "none"; }
</script>
<style> @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
</body>
</html>
