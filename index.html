<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007AFF">
    <title>·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç - ·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûñ·üÅ·ûâ·ûõ·üÅ·ûâ</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            /* Primary Colors - iOS Style */
            --primary: #007AFF;
            --primary-light: rgba(0, 122, 255, 0.1);
            --primary-dark: #0056CC;
            --digital: #00d2ff;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --info: #5AC8FA;
            
            /* Background Colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F2F2F7;
            --bg-tertiary: #E5E5EA;
            --bg-card: #FFFFFF;
            --bg-modal: rgba(0, 0, 0, 0.4);
            
            /* Text Colors */
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #8E8E93;
            --text-quaternary: #C7C7CC;
            --text-on-primary: #FFFFFF;
            
            /* Border & Shadows */
            --border-light: #C6C6C8;
            --border-medium: #D1D1D6;
            --border-heavy: #E5E5EA;
            --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.15);
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 9999px;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1C1C1E;
                --bg-tertiary: #2C2C2E;
                --bg-card: #1C1C1E;
                
                --text-primary: #FFFFFF;
                --text-secondary: #EBEBF5;
                --text-tertiary: #98989D;
                --text-quaternary: #48484A;
                
                --border-light: #38383A;
                --border-medium: #48484A;
                --border-heavy: #58585B;
                
                --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
                --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.5);
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html, body {
            font-family: 'Kantumruy Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            overscroll-behavior: none;
            height: 100%;
            overflow-x: hidden;
        }
        
        /* iOS Style Header */
        .ios-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 88px;
            padding-top: env(safe-area-inset-top, 0px);
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-heavy);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding-left: env(safe-area-inset-left, 0px);
            padding-right: env(safe-area-inset-right, 0px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0 var(--space-lg);
            height: 100%;
        }
        
        .header-left, .header-right {
            flex: 0 0 auto;
            min-width: 60px;
        }
        
        .header-center {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 17px;
            color: var(--text-primary);
        }
        
        .header-title {
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(135deg, var(--primary), var(--digital));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .header-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--digital));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        /* iOS Style Content */
        .ios-content {
            margin-top: 88px;
            margin-bottom: 80px;
            padding: var(--space-lg);
            padding-bottom: calc(var(--space-lg) + env(safe-area-inset-bottom, 0px));
            min-height: calc(100vh - 168px);
        }
        
        /* iOS Style Cards */
        .ios-card {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-heavy);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .ios-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .ios-card-content {
            padding: var(--space-lg);
        }
        
        /* Statistics Cards */
        .stat-card {
            background: var(--bg-card);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-heavy);
            transition: all 0.3s;
            text-align: center;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        /* iOS Style Buttons */
        .ios-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--space-lg);
            height: 44px;
            border-radius: var(--radius-lg);
            font-weight: 500;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            gap: var(--space-sm);
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        
        .ios-btn:active {
            transform: scale(0.98);
        }
        
        .ios-btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--digital));
            color: var(--text-on-primary);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .ios-btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        .ios-btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }
        
        .ios-btn-success {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: var(--text-on-primary);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }
        
        .ios-btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff6b6b);
            color: var(--text-on-primary);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }
        
        .ios-btn-warning {
            background: linear-gradient(135deg, var(--warning), #ffcc00);
            color: var(--text-on-primary);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
        }
        
        .ios-btn-info {
            background: linear-gradient(135deg, var(--info), #5ac8fa);
            color: var(--text-on-primary);
            box-shadow: 0 4px 12px rgba(90, 200, 250, 0.3);
        }
        
        .ios-btn-full {
            width: 100%;
        }
        
        .ios-btn-small {
            height: 36px;
            padding: 0 var(--space-md);
            font-size: 14px;
            border-radius: var(--radius-md);
        }
        
        /* iOS Style Input */
        .ios-input {
            width: 100%;
            padding: var(--space-lg);
            background-color: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .ios-input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--bg-primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .ios-input::placeholder {
            color: var(--text-tertiary);
        }
        
        /* iOS Style Image Upload */
        .ios-image-upload {
            position: relative;
            cursor: pointer;
        }
        
        .ios-image-preview {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            border: 3px solid var(--bg-primary);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            transition: all 0.3s;
        }
        
        .ios-upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        
        /* iOS Style Group List */
        .ios-group-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .ios-group-item {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .ios-group-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s;
        }
        
        .ios-group-item:hover::before {
            transform: scaleY(1);
        }
        
        .ios-group-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .ios-group-item.returned {
            border-color: var(--success);
            background: rgba(52, 199, 89, 0.1);
        }
        
        .ios-group-item.busy {
            border-color: var(--primary);
            background: linear-gradient(to right, rgba(0, 122, 255, 0.05), var(--bg-card));
        }
        
        .ios-group-image {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 2px solid var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .ios-group-info {
            flex: 1;
            min-width: 0;
        }
        
        .ios-group-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ios-group-status {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ios-group-arrow {
            color: var(--text-tertiary);
            font-size: 16px;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        
        .ios-group-item:hover .ios-group-arrow {
            transform: translateX(4px);
            color: var(--primary);
        }
        
        /* iOS Style Modal */
        .ios-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-modal);
            z-index: 2000;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(100px); 
            }
            to { 
                opacity: 1;
                transform: translateY(0); 
            }
        }
        
        .ios-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-heavy);
        }
        
        .ios-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            flex: 1;
            padding: 0 var(--space-sm);
        }
        
        .ios-modal-content {
            padding: var(--space-lg);
            background-color: var(--bg-primary);
            min-height: 100vh;
        }
        
        /* iOS Style Location Box */
        .ios-location-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin: var(--space-lg) 0;
            border: 2px solid var(--primary);
            position: relative;
        }
        
        .ios-location-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }
        
        .ios-location-title-container {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .ios-location-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--digital));
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .ios-location-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .ios-location-actions-header {
            display: flex;
            gap: var(--space-sm);
        }
        
        .ios-location-content {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
        }
        
        .ios-location-display {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .ios-location-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            word-break: break-word;
        }
        
        .ios-location-coordinates {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            word-break: break-word;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-xs);
        }
        
        .ios-location-link {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-top: var(--space-sm);
            transition: all 0.3s;
            border: 1px solid var(--primary);
        }
        
        .ios-location-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .ios-location-link i {
            margin-right: var(--space-xs);
        }
        
        .ios-location-empty {
            color: var(--text-tertiary);
            font-style: italic;
            text-align: center;
            padding: var(--space-xl);
            font-size: 15px;
        }
        
        .ios-location-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
        }
        
        /* Map Preview */
        .ios-map-preview {
            width: 100%;
            height: 150px;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: var(--space-md);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            position: relative;
            border: 1px solid var(--border-heavy);
        }
        
        .ios-map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            gap: var(--space-sm);
        }
        
        .ios-map-preview-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.3s;
        }
        
        .ios-map-preview-btn:hover {
            background: white;
            transform: scale(1.05);
        }
        
        /* Location QR Code */
        .ios-location-qr {
            text-align: center;
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-heavy);
        }
        
        .ios-qr-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .ios-qr-code {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            background: white;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-heavy);
        }
        
        /* iOS Style Tool List */
        .ios-tool-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .ios-tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .ios-tool-item:hover {
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
            transform: translateX(4px);
        }
        
        .ios-tool-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .ios-tool-quantity {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
        }
        
        /* iOS Style Status Indicator */
        .ios-status-indicator {
            text-align: center;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }
        
        .ios-status-returned {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .ios-status-busy {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        /* iOS Style Action Buttons */
        .ios-action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        /* iOS Style Edit Grid */
        .ios-edit-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        
        .ios-edit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .ios-edit-controls {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .ios-quantity-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .ios-quantity-btn:hover {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .ios-quantity-display {
            min-width: 36px;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }
        
        /* iOS Style Summary */
        .ios-summary-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .ios-summary-item {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            padding: var(--space-lg);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--digital);
            transition: all 0.3s;
        }
        
        .ios-summary-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        
        .ios-summary-total {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary);
            text-align: right;
        }
        
        /* iOS Style Search */
        .ios-search-container {
            position: relative;
        }
        
        .ios-search-input {
            width: 180px;
            padding: var(--space-md) 40px var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            font-family: inherit;
            font-size: 14px;
            color: var(--text-primary);
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .ios-search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-light);
            width: 220px;
        }
        
        .ios-search-input::placeholder {
            color: var(--text-tertiary);
        }
        
        .ios-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            pointer-events: none;
        }
        
        /* Notification System */
        .notification-container {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-primary);
        }
        
        .notification-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-heavy);
            margin-top: 10px;
            z-index: 1001;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-heavy);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background: var(--bg-secondary);
        }
        
        .notification-item.unread {
            background: var(--primary-light);
        }
        
        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-tertiary);
            text-align: right;
        }
        
        /* iOS Style Date Picker */
        .ios-date-picker {
            border: none;
            background: var(--bg-card);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        
        .ios-date-picker:hover {
            box-shadow: var(--shadow-sm);
        }
        
        /* iOS Style Empty State */
        .ios-empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-tertiary);
        }
        
        .ios-empty-icon {
            font-size: 36px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }
        
        /* iOS Style Bottom Tab Bar */
        .ios-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-heavy);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        
        .ios-tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            height: 100%;
            text-decoration: none;
            color: var(--text-tertiary);
            transition: all 0.3s;
            position: relative;
        }
        
        .ios-tab-item.active {
            color: var(--primary);
        }
        
        .ios-tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
            transition: transform 0.3s;
        }
        
        .ios-tab-item.active .ios-tab-icon {
            transform: translateY(-2px);
        }
        
        .ios-tab-label {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* Toast Notification */
        .ios-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            font-weight: 500;
            font-size: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            border: 1px solid var(--border-heavy);
        }
        
        .ios-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .ios-toast.success {
            background-color: rgba(52, 199, 89, 0.9);
            color: white;
        }
        
        .ios-toast.error {
            background-color: rgba(255, 59, 48, 0.9);
            color: white;
        }
        
        .ios-toast.warning {
            background-color: rgba(255, 149, 0, 0.9);
            color: white;
        }
        
        .ios-toast.info {
            background-color: rgba(90, 200, 250, 0.9);
            color: white;
        }
        
        /* Location Edit Modal */
        .ios-location-edit-modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            box-shadow: var(--shadow-lg);
            margin: var(--space-lg) 0;
            animation: slideUp 0.3s ease-out;
        }
        
        .ios-location-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        
        .ios-form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .ios-form-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .ios-form-label i {
            color: var(--primary);
        }
        
        .ios-form-input {
            padding: var(--space-md);
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .ios-form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .ios-form-note {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: var(--space-xs);
            line-height: 1.4;
        }
        
        .ios-coordinates-group {
            display: flex;
            gap: var(--space-sm);
        }
        
        .ios-coordinates-group .ios-form-input {
            flex: 1;
        }
        
        .ios-form-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        /* Location Quick Actions */
        .ios-location-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }
        
        .ios-location-quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-heavy);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .ios-location-quick-btn:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .ios-location-quick-icon {
            font-size: 20px;
            margin-bottom: var(--space-xs);
            color: var(--primary);
        }
        
        .ios-location-quick-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Inventory Management */
        .inventory-low {
            border-left: 4px solid var(--danger) !important;
            background: rgba(255, 59, 48, 0.05) !important;
        }
        
        .inventory-medium {
            border-left: 4px solid var(--warning) !important;
            background: rgba(255, 149, 0, 0.05) !important;
        }
        
        .inventory-good {
            border-left: 4px solid var(--success) !important;
            background: rgba(52, 199, 89, 0.05) !important;
        }
        
        /* Transfer System */
        .transfer-item {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
        }
        
        .transfer-from {
            color: var(--danger);
            font-weight: 600;
        }
        
        .transfer-to {
            color: var(--success);
            font-weight: 600;
        }
        
        .transfer-tool {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Settings */
        .settings-section {
            margin-bottom: var(--space-xl);
        }
        
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        /* Animation for loading */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
        
        /* Copy Link Button */
        .ios-copy-link-btn.copied {
            background: var(--success) !important;
        }
        
        .ios-copy-link-btn.copied::after {
            content: '‚úì ·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .ios-content {
                padding: var(--space-md);
            }
            
            .ios-header {
                height: 80px;
            }
            
            .header-content {
                padding: 0 var(--space-md);
            }
            
            .ios-search-input {
                width: 140px;
            }
            
            .ios-search-input:focus {
                width: 160px;
            }
            
            .ios-action-buttons {
                grid-template-columns: 1fr;
            }
            
            .ios-modal-content {
                padding: var(--space-md);
            }
            
            .ios-location-quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ios-map-preview {
                height: 120px;
            }
            
            .notification-panel {
                width: 280px;
                right: -50px;
            }
            
            .stat-card {
                padding: var(--space-sm);
            }
            
            .stat-number {
                font-size: 20px;
            }
        }
        
        /* Print Styles */
        @media print {
            .ios-header, .ios-tab-bar, .ios-btn {
                display: none !important;
            }
            
            .ios-content {
                margin: 0;
                padding: 0;
            }
            
            body {
                background: white;
                color: black;
            }
        }
    </style>
</head>
<body>
    <!-- iOS Header -->
    <header class="ios-header">
        <div class="header-content">
            <div class="header-left">
                <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="scrollToTop()" title="·ûë·üÜ·ûñ·üê·ûö·ûä·ûæ·ûò">
                    <i class="fas fa-home"></i>
                </button>
            </div>
            <div class="header-center">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <span>·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç</span>
                </div>
            </div>
            <div class="header-right">
                <div class="ios-search-container">
                    <input type="text" id="globalSearch" class="ios-search-input" placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ..." onkeyup="handleGlobalSearch(event)">
                    <span class="ios-search-icon">üîç</span>
                </div>
                
                <!-- Notification Bell -->
                <div class="notification-container">
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="toggleNotifications()" title="·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ">
                        <i class="fas fa-bell"></i>
                        <span id="notificationCount" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <div id="notificationPanel" class="notification-panel">
                        <div class="notification-header">
                            <div style="font-weight: 600;">·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ</div>
                            <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="markAllAsRead()">
                                ·ûü·üÜ·û¢·û∂·ûè·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã
                            </button>
                        </div>
                        <div id="notificationList" class="notification-list">
                            <!-- Notifications will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="ios-content">
        <!-- Statistics Dashboard -->
        <div class="ios-card">
            <div class="ios-card-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                    <h3 style="color: var(--primary);"><i class="fas fa-chart-line"></i> ·ûü·üí·ûê·û∑·ûè·û∑·ûö·û†·üê·ûü</h3>
                    <span id="currentTime" style="color: var(--text-tertiary); font-size: 14px;"></span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm); text-align: center; margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-number" id="totalGroups">0</div>
                        <div class="stat-label">·ûÄ·üí·ûö·ûª·ûò·ûü·ûö·ûª·ûî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeTools">0</div>
                        <div class="stat-label">·ûß·ûî·ûÄ·ûö·ûé·üç·ûü·ûÄ·ûò·üí·ûò</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="returnedGroups">0</div>
                        <div class="stat-label">·ûü·ûÑ·ûö·ûΩ·ûÖ</div>
                    </div>
                </div>
                
                <!-- Map Preview -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                        <h4 style="color: var(--primary);"><i class="fas fa-map"></i> ·ûï·üÇ·ûì·ûë·û∏·ûÄ·üí·ûö·ûª·ûò</h4>
                        <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="showAllLocations()">
                            <i class="fas fa-expand"></i> ·ûò·ûæ·ûõ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã
                        </button>
                    </div>
                    <div id="mapPreviewSmall" style="height: 200px; background: var(--bg-secondary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--text-tertiary);">
                        <div style="text-align: center;">
                            <i class="fas fa-map-marker-alt" style="font-size: 32px; margin-bottom: var(--space-sm);"></i>
                            <div>·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûë·ûª·ûÄ·ûï·üÇ·ûì·ûë·û∏...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Group Card -->
        <div class="ios-card">
            <div class="ios-card-content">
                <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-md); align-items: center;">
                    <div class="ios-image-upload" onclick="document.getElementById('fileIn').click()" title="·ûî·ûì·üí·ûê·üÇ·ûò·ûö·ûº·ûî·ûó·û∂·ûñ">
                        <img id="tempImgView" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="ios-image-preview">
                        <div class="ios-upload-overlay">+</div>
                    </div>
                    <input type="file" id="fileIn" style="display:none" accept="image/*" onchange="previewImg(this)">
                    <input type="text" id="gName" class="ios-input" placeholder="·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö...">
                </div>
                <button class="ios-btn ios-btn-primary ios-btn-full" onclick="addGroup()">
                    <i class="fas fa-plus"></i>
                    <span>·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö</span>
                </button>
            </div>
        </div>
        
        <!-- Date Picker and Quick Actions -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
            <input type="date" id="historyDate" class="ios-date-picker" onchange="refreshAll()" style="width: 100%;">
            <button class="ios-btn ios-btn-secondary" onclick="showSettings()">
                <i class="fas fa-cog"></i>
                <span>·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã</span>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); margin-bottom: var(--space-lg);">
            <button class="ios-btn ios-btn-info" onclick="showSummary()">
                <i class="fas fa-chart-bar"></i>
                <span>·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç</span>
            </button>
            <button class="ios-btn ios-btn-warning" onclick="showInventory()">
                <i class="fas fa-boxes"></i>
                <span>·ûë·ûº·ûë·üÖ</span>
            </button>
            <button class="ios-btn ios-btn-success" onclick="exportData('csv')">
                <i class="fas fa-file-export"></i>
                <span>·ûì·û∂·üÜ·ûÖ·üÅ·ûâ</span>
            </button>
            <button class="ios-btn ios-btn-danger" onclick="showAuditLog()">
                <i class="fas fa-history"></i>
                <span>·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑</span>
            </button>
        </div>
        
        <!-- Groups List -->
        <div id="gList" class="ios-group-list"></div>
    </main>
    
    <!-- Bottom Tab Bar -->
    <nav class="ios-tab-bar">
        <a href="#" class="ios-tab-item active" onclick="switchTab('home')">
            <div class="ios-tab-icon">
                <i class="fas fa-home"></i>
            </div>
            <div class="ios-tab-label">·ûë·üÜ·ûñ·üê·ûö·ûä·ûæ·ûò</div>
        </a>
        
        <a href="#" class="ios-tab-item" onclick="switchTab('groups')">
            <div class="ios-tab-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="ios-tab-label">·ûÄ·üí·ûö·ûª·ûò</div>
        </a>
        
        <a href="#" class="ios-tab-item" onclick="showInventory()">
            <div class="ios-tab-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="ios-tab-label">·ûë·ûº·ûë·üÖ</div>
        </a>
        
        <a href="#" class="ios-tab-item" onclick="document.getElementById('gName').focus()">
            <div class="ios-tab-icon">
                <i class="fas fa-plus"></i>
            </div>
            <div class="ios-tab-label">·ûî·ûÑ·üí·ûÄ·ûæ·ûè</div>
        </a>
        
        <a href="#" class="ios-tab-item" onclick="refreshAll()">
            <div class="ios-tab-icon">
                <i class="fas fa-sync-alt"></i>
            </div>
            <div class="ios-tab-label">·ûï·üí·ûë·ûª·ûÄ·û°·ûæ·ûÑ·ûú·û∑·ûâ</div>
        </a>
    </nav>
    
    <!-- Group Details Modal -->
    <div id="mDetails" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mDetails')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title" id="mTitle"></div>
                <div style="display: flex; gap: var(--space-sm);">
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="showTransferModal()">
                        <i class="fas fa-exchange-alt"></i>
                        <span>·ûï·üí·ûë·üÅ·ûö</span>
                    </button>
                    <button class="ios-btn ios-btn-small ios-btn-danger" onclick="delG()">
                        <i class="fas fa-trash"></i>
                        <span>·ûõ·ûª·ûî</span>
                    </button>
                </div>
            </div>
            
            <!-- Location Box -->
            <div class="ios-location-box">
                <div class="ios-location-header">
                    <div class="ios-location-title-container">
                        <div class="ios-location-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="ios-location-title">·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûÄ·üí·ûö·ûª·ûò</div>
                    </div>
                    <div class="ios-location-actions-header">
                        <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="editLocation()" title="·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="ios-btn ios-btn-small ios-btn-primary" onclick="shareLocation()" title="·ûÖ·üÇ·ûÄ·ûö·üÜ·ûõ·üÇ·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="ios-location-content">
                    <div id="locationDisplay" class="ios-location-empty">
                        <div style="margin-bottom: var(--space-md);">
                            <i class="fas fa-map-marker-alt" style="font-size: 32px; opacity: 0.5;"></i>
                        </div>
                        <div>·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                        <div style="font-size: 14px; margin-top: var(--space-xs);">·ûÖ·ûª·ûÖ·ûî·üä·ûº·ûè·ûª·ûÑ "·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ" ·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                    </div>
                    
                    <!-- Map Preview -->
                    <div id="mapPreview" class="ios-map-preview" style="display: none;">
                        <div class="ios-map-overlay">
                            <i class="fas fa-map" style="font-size: 32px;"></i>
                            <div>·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûì·üÅ·üá·ûò·û∂·ûì·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ</div>
                            <a id="openMapLink" class="ios-map-preview-btn" target="_blank">
                                <i class="fas fa-external-link-alt"></i>
                                <span>·ûî·ûæ·ûÄ·ûÄ·üí·ûì·ûª·ûÑ Google Maps</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- QR Code for location -->
                    <div id="locationQR" class="ios-location-qr" style="display: none;">
                        <div class="ios-qr-title">QR Code ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                        <div class="ios-qr-code" id="qrCodeContainer">
                            <!-- QR code will be generated here -->
                        </div>
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: var(--space-sm);">
                            ·ûü·üí·ûÄ·üÅ·ûì·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûæ·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûì·üÖ·ûÄ·üí·ûì·ûª·ûÑ Google Maps
                        </div>
                    </div>
                </div>
                
                <div class="ios-location-actions">
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="editLocation()">
                        <i class="fas fa-edit"></i>
                        <span>·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ</span>
                    </button>
                    <button class="ios-btn ios-btn-small ios-btn-primary" onclick="shareLocation()">
                        <i class="fas fa-share-alt"></i>
                        <span>·ûÖ·üÇ·ûÄ·ûö·üÜ·ûõ·üÇ·ûÄ</span>
                    </button>
                    <button class="ios-btn ios-btn-small ios-btn-success ios-copy-link-btn" id="copyLinkBtn" onclick="copyLocationLink()" style="display: none;">
                        <i class="fas fa-link"></i>
                        <span>·ûÖ·ûò·üí·ûõ·ûÑ Link</span>
                    </button>
                </div>
            </div>
            
            <!-- View Mode -->
            <div id="viewMode">
                <div id="statusTag" class="ios-status-indicator"></div>
                
                <div id="toolList" class="ios-tool-list"></div>
                
                <div class="ios-action-buttons">
                    <button class="ios-btn ios-btn-secondary" onclick="openEdit()">
                        <i class="fas fa-cog"></i>
                        <span>·ûÄ·üÇ·ûÖ·üÜ·ûì·ûΩ·ûì</span>
                    </button>
                    <button class="ios-btn ios-btn-info" onclick="showToolHistory()">
                        <i class="fas fa-history"></i>
                        <span>·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑</span>
                    </button>
                    <button class="ios-btn ios-btn-primary" onclick="sendGroupTelegram()">
                        <i class="fas fa-paper-plane"></i>
                        <span>·ûï·üí·ûâ·ûæ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</span>
                    </button>
                </div>
                
                <button id="returnBtn" class="ios-btn ios-btn-full" onclick="toggleReturn()"></button>
            </div>
            
            <!-- Edit Mode -->
            <div id="editMode" style="display:none;">
                <div id="editGrid" class="ios-edit-grid"></div>
                <button class="ios-btn ios-btn-primary ios-btn-full" onclick="saveTools()">
                    <i class="fas fa-check"></i>
                    <span>·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Location Edit Modal -->
    <div id="mLocationEdit" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mLocationEdit')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                <div style="width: 60px;"></div>
            </div>
            
            <div class="ios-location-edit-modal">
                <div class="ios-location-form">
                    <div class="ios-form-group">
                        <label class="ios-form-label">
                            <i class="fas fa-map-pin"></i>
                            ·ûà·üí·ûò·üÑ·üá·ûÄ·ûì·üí·ûõ·üÇ·ûÑ
                        </label>
                        <input type="text" id="editLocationName" class="ios-form-input" placeholder="·ûß. ·ûï·üí·ûë·üá·ûõ·üÅ·ûÅ·ü°·ü¢, ·ûï·üí·ûõ·ûº·ûú·ü¢·ü†·ü†·ü§, ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ">
                        <div class="ios-form-note">
                            ·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÄ·ûì·üí·ûõ·üÇ·ûÑ·û≤·üí·ûô·ûî·û∂·ûì·ûÖ·üí·ûî·û∂·ûü·üã ·ûä·ûæ·ûò·üí·ûî·û∏·ûÑ·û∂·ûô·ûü·üí·ûö·ûΩ·ûõ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ
                        </div>
                    </div>
                    
                    <div class="ios-form-group">
                        <label class="ios-form-label">
                            <i class="fas fa-globe-asia"></i>
                            ·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ (·ûü·ûò·üí·ûö·û∂·ûî·üã Google Maps)
                        </label>
                        <div class="ios-coordinates-group">
                            <input type="text" id="editLat" class="ios-form-input" placeholder="·ûö·ûô·üà·ûë·ûë·ûπ·ûÑ (Latitude)">
                            <input type="text" id="editLng" class="ios-form-input" placeholder="·ûö·ûô·üà·ûî·ûé·üí·ûè·üÑ·ûô (Longitude)">
                        </div>
                        <div class="ios-form-note">
                            ·ûß·ûë·û∂·û†·ûö·ûé·üç: 11.5564, 104.9282 (·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ)<br>
                            ·ûî·ûæ·ûò·û∑·ûì·ûä·ûπ·ûÑ ·ûÇ·üí·ûö·û∂·ûì·üã·ûè·üÇ·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÄ·ûì·üí·ûõ·üÇ·ûÑ·ûÇ·û∫·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·û∂·ûì·üã
                        </div>
                    </div>
                    
                    <div class="ios-form-actions">
                        <button class="ios-btn ios-btn-secondary" onclick="getCurrentCoords()" style="flex: 1;">
                            <i class="fas fa-crosshairs"></i>
                            <span>·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì</span>
                        </button>
                        <button class="ios-btn ios-btn-primary" onclick="saveLocationEdit()" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            <span>·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ</span>
                        </button>
                    </div>
                    
                    <div class="ios-location-quick-actions">
                        <div class="ios-location-quick-btn" onclick="fillSamplePhnomPenh()">
                            <div class="ios-location-quick-icon">
                                <i class="fas fa-landmark"></i>
                            </div>
                            <div class="ios-location-quick-text">·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ</div>
                        </div>
                        <div class="ios-location-quick-btn" onclick="fillSampleSiemReap()">
                            <div class="ios-location-quick-icon">
                                <i class="fas fa-torii-gate"></i>
                            </div>
                            <div class="ios-location-quick-text">·ûü·üÄ·ûò·ûö·û∂·ûî</div>
                        </div>
                        <div class="ios-location-quick-btn" onclick="fillSampleSihanoukville()">
                            <div class="ios-location-quick-icon">
                                <i class="fas fa-umbrella-beach"></i>
                            </div>
                            <div class="ios-location-quick-text">·ûñ·üí·ûö·üá·ûü·û∏·û†·ûì·ûª</div>
                        </div>
                        <div class="ios-location-quick-btn" onclick="clearCoordinates()">
                            <div class="ios-location-quick-icon">
                                <i class="fas fa-eraser"></i>
                            </div>
                            <div class="ios-location-quick-text">·ûõ·ûª·ûî·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ</div>
                        </div>
                    </div>
                    
                    <div class="ios-form-note" style="text-align: center; margin-top: var(--space-lg);">
                        <i class="fas fa-info-circle"></i>
                        ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûä·üÇ·ûõ·ûò·û∂·ûì·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûì·ûπ·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè Link ·ûë·üÖ·ûÄ·û∂·ûì·üã Google Maps ·ûä·üÑ·ûô·ûü·üí·ûú·üê·ûô·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div id="mTransfer" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mTransfer')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç</div>
                <div style="width: 60px;"></div>
            </div>
            
            <div style="padding: var(--space-lg);">
                <div class="ios-card">
                    <div class="ios-card-content">
                        <div class="ios-form-group">
                            <label class="ios-form-label">
                                <i class="fas fa-tools"></i>
                                ·ûß·ûî·ûÄ·ûö·ûé·üç·ûä·üÇ·ûõ·ûè·üí·ûö·ûº·ûú·ûï·üí·ûë·üÅ·ûö
                            </label>
                            <select id="transferTool" class="ios-form-input">
                                <!-- Tools will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="ios-form-group">
                            <label class="ios-form-label">
                                <i class="fas fa-arrow-right"></i>
                                ·ûÖ·üÜ·ûì·ûΩ·ûì·ûè·üí·ûö·ûº·ûú·ûï·üí·ûë·üÅ·ûö
                            </label>
                            <div style="display: flex; align-items: center; gap: var(--space-md);">
                                <button class="ios-quantity-btn" onclick="adjustTransferQty(-1)">-</button>
                                <input type="number" id="transferQty" class="ios-form-input" value="1" min="1" style="text-align: center;">
                                <button class="ios-quantity-btn" onclick="adjustTransferQty(1)">+</button>
                            </div>
                        </div>
                        
                        <div class="ios-form-group">
                            <label class="ios-form-label">
                                <i class="fas fa-users"></i>
                                ·ûï·üí·ûë·üÅ·ûö·ûë·üÖ·ûÄ·üí·ûö·ûª·ûò
                            </label>
                            <select id="transferToGroup" class="ios-form-input">
                                <!-- Groups will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="ios-form-group">
                            <label class="ios-form-label">
                                <i class="fas fa-comment"></i>
                                ·ûÄ·üÜ·ûé·ûè·üã·ûü·ûò·üí·ûÇ·û∂·ûõ·üã (·ûî·ûæ·ûò·û∂·ûì)
                            </label>
                            <textarea id="transferNote" class="ios-form-input" rows="3" placeholder="·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÄ·üÜ·ûé·ûè·üã·ûü·ûò·üí·ûÇ·û∂·ûõ·üã·ûü·ûò·üí·ûö·û∂·ûî·üã·ûÄ·û∂·ûö·ûï·üí·ûë·üÅ·ûö..."></textarea>
                        </div>
                        
                        <button class="ios-btn ios-btn-primary ios-btn-full" onclick="executeTransfer()">
                            <i class="fas fa-paper-plane"></i>
                            <span>·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç</span>
                        </button>
                    </div>
                </div>
                
                <!-- Transfer History -->
                <div class="ios-card">
                    <div class="ios-card-content">
                        <h4 style="color: var(--primary); margin-bottom: var(--space-md);">
                            <i class="fas fa-history"></i> ·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûï·üí·ûë·üÅ·ûö
                        </h4>
                        <div id="transferHistory" class="ios-group-list">
                            <!-- Transfer history will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inventory Modal -->
    <div id="mInventory" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mInventory')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûë·ûº·ûë·üÖ</div>
                <button class="ios-btn ios-btn-primary" onclick="exportInventory()">
                    <i class="fas fa-file-export"></i>
                    <span>·ûì·û∂·üÜ·ûÖ·üÅ·ûâ</span>
                </button>
            </div>
            
            <div style="padding: var(--space-lg);">
                <!-- Inventory Summary -->
                <div class="ios-card">
                    <div class="ios-card-content">
                        <h3 style="color: var(--primary); margin-bottom: var(--space-md);">
                            <i class="fas fa-clipboard-list"></i> ·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ·ûë·ûº·ûë·üÖ
                        </h3>
                        
                        <div class="ios-tool-list">
                            <div class="ios-tool-item">
                                <span>·ûÖ·üÜ·ûì·ûΩ·ûì·ûß·ûî·ûÄ·ûö·ûé·üç·ûü·ûö·ûª·ûî·ûä·üÇ·ûõ·ûò·û∂·ûì</span>
                                <span id="totalInventory" class="ios-tool-quantity">0</span>
                            </div>
                            <div class="ios-tool-item">
                                <span>·ûß·ûî·ûÄ·ûö·ûé·üç·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã</span>
                                <span id="inUseInventory" class="ios-tool-quantity" style="color: var(--danger);">0</span>
                            </div>
                            <div class="ios-tool-item">
                                <span>·ûß·ûî·ûÄ·ûö·ûé·üç·ûì·üÖ·ûü·ûõ·üã</span>
                                <span id="availableInventory" class="ios-tool-quantity" style="color: var(--success);">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tool Stock Management -->
                <div class="ios-card">
                    <div class="ios-card-content">
                        <h3 style="color: var(--primary); margin-bottom: var(--space-md);">
                            <i class="fas fa-box-open"></i> ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûü·üí·ûè·ûª·ûÄ·ûß·ûî·ûÄ·ûö·ûé·üç
                        </h3>
                        
                        <div id="inventoryList" class="ios-edit-grid">
                            <!-- Inventory items will appear here -->
                        </div>
                        
                        <div style="display: flex; gap: var(--space-sm); margin-top: var(--space-lg);">
                            <button class="ios-btn ios-btn-secondary" style="flex: 1;" onclick="updateAllInventory()">
                                <i class="fas fa-sync-alt"></i> ·ûí·üí·ûú·ûæ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì·ûó·û∂·ûñ
                            </button>
                            <button class="ios-btn ios-btn-primary" style="flex: 1;" onclick="saveInventory()">
                                <i class="fas fa-save"></i> ·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Low Stock Alerts -->
                <div class="ios-card">
                    <div class="ios-card-content">
                        <h3 style="color: var(--warning); margin-bottom: var(--space-md);">
                            <i class="fas fa-exclamation-triangle"></i> ·ûß·ûî·ûÄ·ûö·ûé·üç·ûá·û∑·ûè·û¢·ûü·üã
                        </h3>
                        <div id="lowStockAlerts">
                            <!-- Low stock alerts will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="mSettings" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mSettings')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã</div>
                <button class="ios-btn ios-btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i>
                    <span>·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="settingsContent">
                    <!-- Settings content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Results Modal -->
    <div id="mSearch" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mSearch')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûõ·ûë·üí·ûí·ûï·ûõ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ</div>
                <button class="ios-btn ios-btn-primary" onclick="exportSearchResults()">
                    <i class="fas fa-file-export"></i>
                    <span>·ûì·û∂·üÜ·ûÖ·üÅ·ûâ</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); border-bottom: 2px solid var(--border-heavy); padding-bottom: var(--space-sm);">
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="switchSearchTab('all')" style="flex: 1;">·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</button>
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="switchSearchTab('tools')" style="flex: 1;">·ûß·ûî·ûÄ·ûö·ûé·üç</button>
                    <button class="ios-btn ios-btn-small ios-btn-secondary" onclick="switchSearchTab('groups')" style="flex: 1;">·ûÄ·üí·ûö·ûª·ûò</button>
                </div>
                <div id="searchResults" style="max-height: 70vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Summary Modal -->
    <div id="mSummary" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mSummary')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·ûö·ûª·ûî</div>
                <button class="ios-btn ios-btn-primary" onclick="sendFullTelegram()">
                    <i class="fas fa-paper-plane"></i>
                    <span>·ûï·üí·ûâ·ûæ</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="summaryContent" class="ios-summary-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Notifications Modal -->
    <div id="mNotifications" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mNotifications')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</div>
                <button class="ios-btn ios-btn-primary" onclick="sendNotificationReport()">
                    <i class="fas fa-paper-plane"></i>
                    <span>·ûï·üí·ûâ·ûæ·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="allNotifications"></div>
            </div>
        </div>
    </div>
    
    <!-- Audit Log Modal -->
    <div id="mAuditLog" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mAuditLog')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ</div>
                <button class="ios-btn ios-btn-primary" onclick="exportAuditLog()">
                    <i class="fas fa-file-export"></i>
                    <span>·ûì·û∂·üÜ·ûÖ·üÅ·ûâ</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="auditLogContent"></div>
            </div>
        </div>
    </div>
    
    <!-- All Locations Modal -->
    <div id="mAllLocations" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mAllLocations')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûÄ·üí·ûö·ûª·ûò·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</div>
                <button class="ios-btn ios-btn-primary" onclick="exportLocations()">
                    <i class="fas fa-share-alt"></i>
                    <span>·ûÖ·üÇ·ûÄ·ûö·üÜ·ûõ·üÇ·ûÄ</span>
                </button>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="allLocationsList"></div>
            </div>
        </div>
    </div>
    
    <!-- Tool History Modal -->
    <div id="mToolHistory" class="ios-modal">
        <div class="ios-modal-content">
            <div class="ios-modal-header">
                <button class="ios-btn ios-btn-secondary" onclick="closeM('mToolHistory')">
                    <i class="fas fa-arrow-left"></i>
                    <span>·ûè·üí·ûö·û°·ûî·üã</span>
                </button>
                <div class="ios-modal-title">·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûß·ûî·ûÄ·ûö·ûé·üç</div>
                <div style="width: 60px;"></div>
            </div>
            <div style="padding: var(--space-lg);">
                <div id="toolHistoryContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBIDnykmBq9wWb-9isKJiji4TgIBwHQ-ZA",
            authDomain: "toolmanagement-2f44d.firebaseapp.com",
            projectId: "toolmanagement-2f44d",
            databaseURL: "https://toolmanagement-2f44d-default-rtdb.firebaseio.com/"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let groups = {};
        let records = {};
        let curId = null;
        let tempImg = "";
        let currentLocation = null;
        let searchTimeout = null;
        let locationMapUrl = "";
        let locationShareText = "";
        let notifications = [];
        let masterInventory = {};
        let auditLog = [];
        let settings = {};
        
        // Tools Master List with initial inventory
        const toolsMaster = [
            { name: "·ûò·üâ·ûº·ûë·üê·ûö·ûî·ûª·ûÄ·ûí·üÜ", initialStock: 10 },
            { name: "·ûò·üâ·ûº·ûë·üê·ûö·ûî·ûª·ûÄ·ûè·ûº·ûÖ", initialStock: 15 },
            { name: "·ûò·üâ·ûº·ûë·üê·ûö·ûÄ·û∂·ûè·üã·ûí·üÜ", initialStock: 8 },
            { name: "·ûò·üâ·ûº·ûë·üê·ûö·ûÄ·û∂·ûè·üã·ûè·ûº·ûÖ", initialStock: 12 },
            { name: "·ûä·üÇ·ûÄ·ûè·üí·ûî·üÇ·ûÑ", initialStock: 20 },
            { name: "·ûè·û∂·ûü·üÅ·üá", initialStock: 25 },
            { name: "·ûî·üâ·üÇ·ûõ", initialStock: 30 },
            { name: "·ûÖ·ûî", initialStock: 40 },
            { name: "·ûÄ·û∂·ûú", initialStock: 50 },
            { name: "·ûö·ûé·û∂", initialStock: 15 },
            { name: "·ûö·ûë·üÅ·üá", initialStock: 5 }
        ];
        
        // Sample coordinates for Cambodia
        const sampleLocations = {
            phnomPenh: {
                name: "·ûë·û∏·ûÄ·üí·ûö·ûª·ûÑ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ",
                lat: 11.5564,
                lng: 104.9282
            },
            siemReap: {
                name: "·ûë·û∏·ûÄ·üí·ûö·ûª·ûÑ·ûü·üÄ·ûò·ûö·û∂·ûî",
                lat: 13.3671,
                lng: 103.8448
            },
            sihanoukville: {
                name: "·ûë·û∏·ûÄ·üí·ûö·ûª·ûÑ·ûñ·üí·ûö·üá·ûü·û∏·û†·ûì·ûª",
                lat: 10.6275,
                lng: 103.5222
            }
        };
        
        // Default settings
        const defaultSettings = {
            language: 'km',
            theme: 'auto',
            notifications: {
                lowStock: true,
                overdue: true,
                transfer: true,
                location: true
            },
            inventory: {
                lowStockThreshold: 3,
                mediumStockThreshold: 10
            },
            security: {
                requirePin: false,
                pin: null
            }
        };
        
        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        
        // Initialize application
        function initializeApp() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('historyDate').value = today;
            document.getElementById('historyDate').max = today;
            
            // Load settings
            loadSettings();
            
            // Setup realtime clock
            updateClock();
            setInterval(updateClock, 60000);
            
            // Setup offline support
            setupOfflineSupport();
            
            // Focus on group name input
            document.getElementById('gName').focus();
            
            // Initialize master inventory
            initializeMasterInventory();
            
            // Load audit log
            loadAuditLog();
            
            // Load notifications
            loadNotifications();
        }
        
        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('app_settings');
            settings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            
            // Apply theme
            applyTheme(settings.theme);
            
            // Apply language
            applyLanguage(settings.language);
        }
        
        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('app_settings', JSON.stringify(settings));
            showToast('·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã', 'success');
            closeM('mSettings');
        }
        
        // Apply theme
        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.style.setProperty('--bg-primary', '#FFFFFF');
                document.documentElement.style.setProperty('--bg-secondary', '#F2F2F7');
                document.documentElement.style.setProperty('--bg-card', '#FFFFFF');
            } else if (theme === 'dark') {
                document.documentElement.style.setProperty('--bg-primary', '#000000');
                document.documentElement.style.setProperty('--bg-secondary', '#1C1C1E');
                document.documentElement.style.setProperty('--bg-card', '#1C1C1E');
            }
        }
        
        // Apply language
        function applyLanguage(lang) {
            // This is a simple implementation
            // In a full app, you would have translation files
            console.log('Language changed to:', lang);
        }
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('km-KH', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            const dateString = now.toLocaleDateString('km-KH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = `${timeString} - ${dateString}`;
        }
        
        // Initialize master inventory
        function initializeMasterInventory() {
            toolsMaster.forEach(tool => {
                masterInventory[tool.name] = tool.initialStock;
            });
            
            // Load saved inventory from Firebase
            rdb.ref('inventory').once('value', (snapshot) => {
                const savedInventory = snapshot.val();
                if (savedInventory) {
                    masterInventory = { ...masterInventory, ...savedInventory };
                }
            });
        }
        
        // Load audit log
        function loadAuditLog() {
            rdb.ref('audit_logs').on('value', (snapshot) => {
                const logs = snapshot.val() || {};
                auditLog = Object.values(logs).sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
            });
        }
        
        // Load notifications
        function loadNotifications() {
            rdb.ref('notifications').on('value', (snapshot) => {
                const allNotifications = snapshot.val() || {};
                notifications = Object.values(allNotifications)
                    .filter(n => !n.read)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                updateNotificationBadge();
            });
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationCount');
            if (notifications.length > 0) {
                badge.textContent = notifications.length > 99 ? '99+' : notifications.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ============================================
        // CORE FUNCTIONS
        // ============================================
        
        // Firebase Data Listener
        rdb.ref().on('value', snap => {
            const data = snap.val() || {};
            groups = data.groups || {};
            records = data.daily_records || {};
            refreshAll();
        });
        
        // Get Effective Data for a Date
        function getEffectiveData(gid, date) {
            if (records[date] && records[date][gid]) {
                return records[date][gid];
            }
            
            let allDates = Object.keys(records).sort().reverse();
            for (let d of allDates) {
                if (d < date && records[d][gid]) {
                    if (!records[d][gid].isReturned) {
                        return records[d][gid];
                    } else {
                        break;
                    }
                }
            }
            
            return { items: {}, isReturned: false };
        }
        
        // Refresh All Views
        function refreshAll() {
            renderGroups();
            updateStatistics();
            checkLowStock();
            if (curId) renderDetails();
        }
        
        // Render Groups List
        function renderGroups() {
            const date = document.getElementById('historyDate').value;
            const gList = document.getElementById('gList');
            
            if (Object.keys(groups).length === 0) {
                gList.innerHTML = `
                    <div class="ios-empty-state">
                        <div class="ios-empty-icon"><i class="fas fa-tools"></i></div>
                        <p>·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö·ûì·üÖ·û°·ûæ·ûô</p>
                        <p style="font-size: 14px; margin-top: var(--space-sm);">·ûü·ûº·ûò·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûÄ·üí·ûö·ûª·ûò·ûä·üÜ·ûî·ûº·ûÑ·ûä·üÑ·ûô·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÅ·û∂·ûÑ·ûõ·ûæ</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            for (let id in groups) {
                const data = getEffectiveData(id, date);
                const hasItems = Object.keys(data.items || {}).length > 0;
                
                let statusClass = '';
                let statusText = '';
                let statusColor = '';
                
                if (data.isReturned) {
                    statusClass = 'returned';
                    statusText = '‚úÖ ·ûü·ûÑ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã';
                    statusColor = 'color: var(--success);';
                } else if (hasItems) {
                    statusClass = 'busy';
                    statusText = 'üïí ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã';
                    statusColor = 'color: var(--primary);';
                } else {
                    statusText = 'üì≠ ·ûë·üÜ·ûì·üÅ·ûö';
                    statusColor = 'color: var(--text-tertiary);';
                }
                
                html += `
                    <div class="ios-group-item ${statusClass}" onclick="openG('${id}')">
                        <img src="${groups[id].img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                             class="ios-group-image" 
                             alt="${groups[id].name}">
                        <div class="ios-group-info">
                            <div class="ios-group-name">${groups[id].name}</div>
                            <div class="ios-group-status" style="${statusColor}">
                                ${statusText}
                            </div>
                        </div>
                        <div class="ios-group-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                `;
            }
            
            gList.innerHTML = html;
        }
        
        // Update statistics
        function updateStatistics() {
            const date = document.getElementById('historyDate').value;
            let totalGroups = Object.keys(groups).length;
            let activeTools = 0;
            let returnedGroups = 0;
            
            Object.keys(groups).forEach(groupId => {
                const data = getEffectiveData(groupId, date);
                
                if (data.isReturned) {
                    returnedGroups++;
                } else {
                    Object.keys(data.items || {}).forEach(tool => {
                        activeTools += data.items[tool];
                    });
                }
            });
            
            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('activeTools').textContent = activeTools;
            document.getElementById('returnedGroups').textContent = returnedGroups;
        }
        
        // Open Group Details
        function openG(id) {
            curId = id;
            document.getElementById('mTitle').innerText = groups[id].name;
            document.getElementById('mDetails').style.display = "block";
            document.getElementById('viewMode').style.display = "block";
            document.getElementById('editMode').style.display = "none";
            
            loadLocation();
            renderDetails();
            loadTransferHistory();
            
            // Log activity
            logActivity('VIEW_GROUP', { groupId: id, groupName: groups[id].name });
        }
        
        // Render Group Details
        function renderDetails() {
            const date = document.getElementById('historyDate').value;
            const data = getEffectiveData(curId, date);
            const toolList = document.getElementById('toolList');
            
            if (Object.keys(data.items || {}).length === 0) {
                toolList.innerHTML = `
                    <div class="ios-empty-state">
                        <div class="ios-empty-icon"><i class="fas fa-box"></i></div>
                        <p>·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûß·ûî·ûÄ·ûö·ûé·üç·ûì·üÖ·û°·ûæ·ûô</p>
                        <p style="font-size: 14px; margin-top: var(--space-sm);">·ûÖ·ûª·ûÖ·ûî·üä·ûº·ûè·ûª·ûÑ "·ûÄ·üÇ·ûÖ·üÜ·ûì·ûΩ·ûì" ·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûß·ûî·ûÄ·ûö·ûé·üç</p>
                    </div>
                `;
            } else {
                let html = '';
                for (let tool in data.items) {
                    const totalStock = masterInventory[tool] || 0;
                    const usedStock = data.items[tool];
                    const availableStock = totalStock - usedStock;
                    
                    let stockClass = 'inventory-good';
                    if (availableStock <= settings.inventory.lowStockThreshold) {
                        stockClass = 'inventory-low';
                    } else if (availableStock <= settings.inventory.mediumStockThreshold) {
                        stockClass = 'inventory-medium';
                    }
                    
                    html += `
                        <div class="ios-tool-item ${stockClass}" onclick="searchTool('${tool}')">
                            <span class="ios-tool-name">${tool}</span>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span class="ios-tool-quantity">x${data.items[tool]}</span>
                                <span style="font-size: 11px; color: var(--text-tertiary);">
                                    ·ûì·üÖ·ûü·ûõ·üã: ${availableStock}
                                </span>
                            </div>
                        </div>
                    `;
                }
                toolList.innerHTML = html;
            }
            
            const returnBtn = document.getElementById('returnBtn');
            const statusTag = document.getElementById('statusTag');
            
            if (data.isReturned) {
                returnBtn.innerHTML = `<i class="fas fa-sync-alt"></i><span>·ûî·üí·ûè·ûº·ûö·ûë·üÖ·ûá·û∂·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûü·ûÑ·ûú·û∑·ûâ</span>`;
                returnBtn.className = "ios-btn ios-btn-secondary ios-btn-full";
                statusTag.innerHTML = `<i class="fas fa-check-circle"></i><span>·ûÄ·üí·ûö·ûª·ûò·ûì·üÅ·üá·ûî·û∂·ûì·ûü·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã</span>`;
                statusTag.className = "ios-status-indicator ios-status-returned";
            } else {
                returnBtn.innerHTML = `<i class="fas fa-box"></i><span>·ûü·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã</span>`;
                returnBtn.className = "ios-btn ios-btn-success ios-btn-full";
                statusTag.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>·ûß·ûî·ûÄ·ûö·ûé·üç·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûê·û∑·ûè·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã</span>`;
                statusTag.className = "ios-status-indicator ios-status-busy";
            }
        }
        
        // ============================================
        // LOCATION FUNCTIONS
        // ============================================
        
        // Load location with improved display
        function loadLocation() {
            if (!curId) return;
            
            const locationDisplay = document.getElementById('locationDisplay');
            const mapPreview = document.getElementById('mapPreview');
            const locationQR = document.getElementById('locationQR');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            const openMapLink = document.getElementById('openMapLink');
            const groupRef = rdb.ref('groups/' + curId + '/location');
            
            groupRef.once('value', (snapshot) => {
                const location = snapshot.val();
                currentLocation = location;
                
                if (location) {
                    // Generate Google Maps URL if coordinates exist
                    if (location.lat && location.lng) {
                        locationMapUrl = `https://www.google.com/maps?q=${location.lat},${location.lng}&z=17`;
                        locationShareText = `${location.name} - ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`;
                        
                        // Show map preview
                        mapPreview.style.display = 'block';
                        openMapLink.href = locationMapUrl;
                        
                        // Show QR code section
                        locationQR.style.display = 'block';
                        generateQRCode(locationMapUrl);
                        
                        // Show copy link button
                        copyLinkBtn.style.display = 'flex';
                    } else {
                        locationMapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.name)}`;
                        locationShareText = location.name;
                        
                        // Hide map preview and QR code
                        mapPreview.style.display = 'none';
                        locationQR.style.display = 'none';
                        copyLinkBtn.style.display = 'flex';
                    }
                    
                    // Update location display
                    locationDisplay.innerHTML = `
                        <div class="ios-location-display">
                            <div class="ios-location-name">
                                <i class="fas fa-map-marker-alt" style="color: var(--primary); margin-right: var(--space-xs);"></i>
                                ${location.name || '·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûò·û∑·ûì·ûò·û∂·ûì·ûà·üí·ûò·üÑ·üá'}
                            </div>
                            
                            ${location.lat && location.lng ? `
                                <div class="ios-location-coordinates">
                                    <i class="fas fa-globe-asia" style="color: var(--success);"></i>
                                    <span>${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</span>
                                </div>
                            ` : ''}
                            
                            ${locationMapUrl ? `
                                <a href="${locationMapUrl}" class="ios-location-link" target="_blank">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>·ûî·ûæ·ûÄ·ûÄ·üí·ûì·ûª·ûÑ Google Maps</span>
                                </a>
                            ` : ''}
                        </div>
                    `;
                    locationDisplay.className = '';
                } else {
                    // No location set
                    locationDisplay.innerHTML = `
                        <div style="margin-bottom: var(--space-md);">
                            <i class="fas fa-map-marker-alt" style="font-size: 32px; opacity: 0.5;"></i>
                        </div>
                        <div>·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                        <div style="font-size: 14px; margin-top: var(--space-xs);">·ûÖ·ûª·ûÖ·ûî·üä·ûº·ûè·ûª·ûÑ "·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ" ·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ</div>
                    `;
                    locationDisplay.className = 'ios-location-empty';
                    
                    // Hide map preview and QR code
                    mapPreview.style.display = 'none';
                    locationQR.style.display = 'none';
                    copyLinkBtn.style.display = 'none';
                    
                    locationMapUrl = "";
                    locationShareText = "";
                }
            });
        }
        
        // Generate QR Code for location URL
        function generateQRCode(url) {
            const qrContainer = document.getElementById('qrCodeContainer');
            
            // Clear previous QR code
            qrContainer.innerHTML = '';
            
            // Create a simple QR code visualization
            const canvas = document.createElement('canvas');
            canvas.width = 120;
            canvas.height = 120;
            const ctx = canvas.getContext('2d');
            
            // Draw QR code background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 120, 120);
            
            // Draw simple QR pattern
            ctx.fillStyle = 'black';
            
            // Draw positioning squares
            ctx.fillRect(10, 10, 20, 20);
            ctx.fillRect(90, 10, 20, 20);
            ctx.fillRect(10, 90, 20, 20);
            
            // Draw some pattern
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    if ((i + j) % 3 === 0) {
                        ctx.fillRect(20 + i * 10, 20 + j * 10, 5, 5);
                    }
                }
            }
            
            // Add text
            ctx.fillStyle = '#007AFF';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üìç', 60, 65);
            
            qrContainer.appendChild(canvas);
            
            // Make QR code clickable
            canvas.style.cursor = 'pointer';
            canvas.title = '·ûÖ·ûª·ûÖ·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûæ·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûì·üÖ·ûÄ·üí·ûì·ûª·ûÑ Google Maps';
            canvas.onclick = function() {
                window.open(url, '_blank');
            };
        }
        
        // Copy location link to clipboard
        function copyLocationLink() {
            if (!locationMapUrl) {
                showToast('·ûò·û∑·ûì·ûò·û∂·ûì Link ·ûë·û∏·ûè·û∂·üÜ·ûÑ', 'error');
                return;
            }
            
            // Create a temporary textarea to copy text
            const textArea = document.createElement('textarea');
            textArea.value = locationMapUrl;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    // Show copied feedback
                    const copyBtn = document.getElementById('copyLinkBtn');
                    copyBtn.classList.add('copied');
                    copyBtn.innerHTML = '<i class="fas fa-check"></i><span>·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ</span>';
                    
                    showToast('·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ Link ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûë·üÖ·ûÄ·üí·ûè·û∂·ûö·ûè·ûò·üí·ûî·üÄ·ûè·ûÅ·üí·ûë·û∂·ûü·üã', 'success');
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        copyBtn.classList.remove('copied');
                        copyBtn.innerHTML = '<i class="fas fa-link"></i><span>·ûÖ·ûò·üí·ûõ·ûÑ Link</span>';
                    }, 2000);
                } else {
                    showToast('·ûò·û∑·ûì·û¢·û∂·ûÖ·ûÖ·ûò·üí·ûõ·ûÑ Link ·ûî·û∂·ûì', 'error');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûÖ·ûò·üí·ûõ·ûÑ Link', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        // Edit location
        function editLocation() {
            if (!curId) return;
            
            const locationDisplay = document.getElementById('locationDisplay');
            const hasLocation = !locationDisplay.classList.contains('ios-location-empty');
            
            if (hasLocation && currentLocation) {
                document.getElementById('editLocationName').value = currentLocation.name || '';
                document.getElementById('editLat').value = currentLocation.lat || '';
                document.getElementById('editLng').value = currentLocation.lng || '';
            } else {
                document.getElementById('editLocationName').value = '';
                document.getElementById('editLat').value = '';
                document.getElementById('editLng').value = '';
            }
            
            document.getElementById('mLocationEdit').style.display = 'block';
        }
        
        // Fill sample coordinates for Phnom Penh
        function fillSamplePhnomPenh() {
            document.getElementById('editLocationName').value = sampleLocations.phnomPenh.name;
            document.getElementById('editLat').value = sampleLocations.phnomPenh.lat;
            document.getElementById('editLng').value = sampleLocations.phnomPenh.lng;
            showToast('·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ', 'info');
        }
        
        // Fill sample coordinates for Siem Reap
        function fillSampleSiemReap() {
            document.getElementById('editLocationName').value = sampleLocations.siemReap.name;
            document.getElementById('editLat').value = sampleLocations.siemReap.lat;
            document.getElementById('editLng').value = sampleLocations.siemReap.lng;
            showToast('·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûü·üÄ·ûò·ûö·û∂·ûî', 'info');
        }
        
        // Fill sample coordinates for Sihanoukville
        function fillSampleSihanoukville() {
            document.getElementById('editLocationName').value = sampleLocations.sihanoukville.name;
            document.getElementById('editLat').value = sampleLocations.sihanoukville.lat;
            document.getElementById('editLng').value = sampleLocations.sihanoukville.lng;
            showToast('·ûî·û∂·ûì·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûñ·üí·ûö·üá·ûü·û∏·û†·ûì·ûª', 'info');
        }
        
        // Clear coordinates
        function clearCoordinates() {
            document.getElementById('editLat').value = '';
            document.getElementById('editLng').value = '';
            showToast('·ûî·û∂·ûì·ûõ·ûª·ûî·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ', 'info');
        }
        
        // Get current coordinates
        function getCurrentCoords() {
            if (!navigator.geolocation) {
                showToast('·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûö·ûª·ûÄ·ûö·ûÄ·ûò·û∑·ûì·ûÇ·û∂·üÜ·ûë·üí·ûö·ûë·û∏·ûè·û∂·üÜ·ûÑ', 'error');
                return;
            }
            
            showToast('·ûÄ·üÜ·ûñ·ûª·ûÑ·ûë·û∂·ûâ·ûô·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('editLat').value = lat.toFixed(6);
                    document.getElementById('editLng').value = lng.toFixed(6);
                    
                    // Try to get location name using reverse geocoding
                    getLocationName(lat, lng);
                    
                    showToast('·ûî·û∂·ûì·ûë·û∂·ûâ·ûô·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                },
                (error) => {
                    let errorMessage = '·ûò·û∑·ûì·û¢·û∂·ûÖ·ûë·û∂·ûâ·ûô·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì·ûî·û∂·ûì';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '·ûü·ûº·ûò·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûü·û∑·ûë·üí·ûí·û∑·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûñ·û∏·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûö·ûª·ûÄ·ûö·ûÄ';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã·ûî·û∂·ûì';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '·ûñ·üÅ·ûõ·ûú·üÅ·ûõ·û∂·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·û¢·ûü·üã·û†·ûæ·ûô';
                            break;
                    }
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Get location name from coordinates
        async function getLocationName(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.display_name) {
                    // Extract a shorter location name
                    let locationName = data.display_name;
                    
                    // Try to get the most relevant part of the address
                    if (data.address) {
                        if (data.address.road) {
                            locationName = data.address.road;
                            if (data.address.house_number) {
                                locationName = `·ûï·üí·ûë·üá·ûõ·üÅ·ûÅ ${data.address.house_number}, ${locationName}`;
                            }
                        } else if (data.address.village) {
                            locationName = data.address.village;
                        } else if (data.address.town) {
                            locationName = data.address.town;
                        } else if (data.address.city) {
                            locationName = data.address.city;
                        }
                    }
                    
                    // Only update if location name field is empty
                    if (!document.getElementById('editLocationName').value.trim()) {
                        document.getElementById('editLocationName').value = locationName;
                    }
                }
            } catch (error) {
                console.log('Could not get location name:', error);
            }
        }
        
        // Save location edit
        function saveLocationEdit() {
            if (!curId) {
                showToast('·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûÄ·üí·ûö·ûª·ûò·ûò·ûª·ûì·ûì·ûπ·ûÑ·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ', 'error');
                return;
            }
            
            const locationName = document.getElementById('editLocationName').value.trim();
            const latInput = document.getElementById('editLat').value.trim();
            const lngInput = document.getElementById('editLng').value.trim();
            
            if (!locationName) {
                showToast('·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÄ·ûì·üí·ûõ·üÇ·ûÑ', 'warning');
                document.getElementById('editLocationName').focus();
                return;
            }
            
            let locationData = {
                name: locationName,
                updatedAt: new Date().toISOString(),
                updatedBy: 'user'
            };
            
            if (latInput && lngInput) {
                const lat = parseFloat(latInput);
                const lng = parseFloat(lngInput);
                
                if (isNaN(lat) || isNaN(lng)) {
                    showToast('·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú', 'error');
                    return;
                }
                
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    showToast('·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú', 'error');
                    return;
                }
                
                locationData.lat = lat;
                locationData.lng = lng;
                
                // Generate Google Maps link
                locationData.mapsUrl = `https://www.google.com/maps?q=${lat},${lng}&z=17`;
                locationData.shareableLink = `https://maps.google.com/?q=${lat},${lng}`;
            } else {
                // Generate search-based Google Maps link
                locationData.mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName)}`;
                locationData.shareableLink = `https://maps.google.com/?q=${encodeURIComponent(locationName)}`;
            }
            
            // Save to Firebase
            rdb.ref('groups/' + curId + '/location').set(locationData)
                .then(() => {
                    showToast('·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                    currentLocation = locationData;
                    loadLocation();
                    closeM('mLocationEdit');
                    
                    // Log activity
                    logActivity('UPDATE_LOCATION', { 
                        groupId: curId, 
                        groupName: groups[curId].name,
                        location: locationData 
                    });
                    
                    // Send notification
                    if (settings.notifications.location) {
                        createNotification(
                            '·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ',
                            `·ûÄ·üí·ûö·ûª·ûò "${groups[curId].name}" ·ûî·û∂·ûì·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûë·üÖ "${locationData.name}"`,
                            'location',
                            curId
                        );
                    }
                })
                .catch((error) => {
                    showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûë·û∏·ûè·û∂·üÜ·ûÑ', 'error');
                    console.error('Save location error:', error);
                });
        }
        
        // Share location with improved options
        function shareLocation() {
            if (!currentLocation) {
                showToast('·ûü·ûº·ûò·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûò·ûª·ûì·ûì·ûπ·ûÑ·ûÖ·üÇ·ûÄ·ûö·üÜ·ûõ·üÇ·ûÄ', 'warning');
                return;
            }
            
            const groupName = groups[curId] ? groups[curId].name : '·ûÄ·üí·ûö·ûª·ûò';
            
            // Create share message with different options
            let message = `üìç *·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûÄ·üí·ûö·ûª·ûò:* ${groupName}\n`;
            message += `üìå *·ûë·û∏·ûè·û∂·üÜ·ûÑ:* ${currentLocation.name}\n`;
            
            if (currentLocation.lat && currentLocation.lng) {
                const mapsUrl = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}&z=17`;
                const shortUrl = `https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
                
                message += `üåê *·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ:* ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}\n`;
                message += `üó∫Ô∏è *Google Maps:* ${shortUrl}\n`;
                message += `üì± *·ûü·üí·ûÄ·üÅ·ûì QR Code:* ·ûî·ûæ·ûÄ·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûü·üí·ûÄ·üÅ·ûì QR Code ·ûì·û∑·ûÑ·ûü·üí·ûÄ·üÅ·ûì·ûö·ûº·ûî·ûó·û∂·ûñ·ûÅ·û∂·ûÑ·ûõ·ûæ`;
            } else {
                const searchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentLocation.name)}`;
                message += `üó∫Ô∏è *Google Maps:* ${searchUrl}\n`;
            }
            
            message += `üìÖ *·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë:* ${new Date().toLocaleDateString('km-KH')}`;
            
            // Show share options
            if (navigator.share && navigator.canShare) {
                // Use Web Share API if available
                navigator.share({
                    title: `·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûÄ·üí·ûö·ûª·ûò: ${groupName}`,
                    text: message.replace(/\*/g, ''),
                    url: currentLocation.mapsUrl || currentLocation.shareableLink
                }).catch(err => {
                    console.log('Share cancelled or failed:', err);
                    // Fallback to Telegram
                    sendTelegramMessage(message);
                });
            } else {
                // Fallback to Telegram
                sendTelegramMessage(message);
            }
        }
        
        // ============================================
        // TRANSFER SYSTEM FUNCTIONS
        // ============================================
        
        // Show transfer modal
        function showTransferModal() {
            if (!curId) return;
            
            const date = document.getElementById('historyDate').value;
            const data = getEffectiveData(curId, date);
            
            // Populate tools dropdown
            const toolSelect = document.getElementById('transferTool');
            toolSelect.innerHTML = '<option value="">·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûß·ûî·ûÄ·ûö·ûé·üç</option>';
            
            Object.keys(data.items || {}).forEach(tool => {
                if (data.items[tool] > 0) {
                    toolSelect.innerHTML += `<option value="${tool}">${tool} (${data.items[tool]} ·ûÇ·üí·ûö·ûø·ûÑ)</option>`;
                }
            });
            
            // Populate groups dropdown (excluding current group)
            const groupSelect = document.getElementById('transferToGroup');
            groupSelect.innerHTML = '<option value="">·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûÄ·üí·ûö·ûª·ûò</option>';
            
            Object.keys(groups).forEach(groupId => {
                if (groupId !== curId) {
                    groupSelect.innerHTML += `<option value="${groupId}">${groups[groupId].name}</option>`;
                }
            });
            
            document.getElementById('mTransfer').style.display = 'block';
        }
        
        // Adjust transfer quantity
        function adjustTransferQty(delta) {
            const input = document.getElementById('transferQty');
            let current = parseInt(input.value) || 1;
            current = Math.max(1, current + delta);
            input.value = current;
        }
        
        // Execute transfer
        function executeTransfer() {
            const tool = document.getElementById('transferTool').value;
            const quantity = parseInt(document.getElementById('transferQty').value);
            const toGroupId = document.getElementById('transferToGroup').value;
            const note = document.getElementById('transferNote').value.trim();
            
            if (!tool || !toGroupId || !quantity) {
                showToast('·ûü·ûº·ûò·ûî·üÜ·ûñ·üÅ·ûâ·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·û∂·ûì·üã', 'warning');
                return;
            }
            
            const date = document.getElementById('historyDate').value;
            const fromData = getEffectiveData(curId, date);
            const toData = getEffectiveData(toGroupId, date);
            
            // Check if source has enough tools
            if (!fromData.items[tool] || fromData.items[tool] < quantity) {
                showToast('·ûß·ûî·ûÄ·ûö·ûé·üç·ûò·û∑·ûì·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·û∂·ûì·üã·ûü·ûò·üí·ûö·û∂·ûî·üã·ûï·üí·ûë·üÅ·ûö', 'error');
                return;
            }
            
            // Calculate new quantities
            const newFromQuantity = fromData.items[tool] - quantity;
            const newToQuantity = (toData.items[tool] || 0) + quantity;
            
            // Update source group
            const updatedFromItems = { ...fromData.items };
            if (newFromQuantity > 0) {
                updatedFromItems[tool] = newFromQuantity;
            } else {
                delete updatedFromItems[tool];
            }
            
            // Update destination group
            const updatedToItems = { ...toData.items };
            updatedToItems[tool] = newToQuantity;
            
            // Save to Firebase
            Promise.all([
                rdb.ref(`daily_records/${date}/${curId}`).set({
                    items: updatedFromItems,
                    isReturned: fromData.isReturned
                }),
                rdb.ref(`daily_records/${date}/${toGroupId}`).set({
                    items: updatedToItems,
                    isReturned: toData.isReturned
                }),
                rdb.ref('transfers').push().set({
                    fromGroupId: curId,
                    fromGroupName: groups[curId].name,
                    toGroupId: toGroupId,
                    toGroupName: groups[toGroupId].name,
                    tool: tool,
                    quantity: quantity,
                    note: note,
                    date: date,
                    timestamp: new Date().toISOString(),
                    createdBy: 'user'
                })
            ])
            .then(() => {
                showToast('·ûî·û∂·ûì·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                closeM('mTransfer');
                renderDetails();
                loadTransferHistory();
                
                // Log activity
                logActivity('TRANSFER_TOOL', {
                    fromGroupId: curId,
                    fromGroupName: groups[curId].name,
                    toGroupId: toGroupId,
                    toGroupName: groups[toGroupId].name,
                    tool: tool,
                    quantity: quantity
                });
                
                // Send notification
                if (settings.notifications.transfer) {
                    createNotification(
                        '·ûÄ·û∂·ûö·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç',
                        `·ûß·ûî·ûÄ·ûö·ûé·üç "${tool}" (${quantity} ·ûÇ·üí·ûö·ûø·ûÑ) ·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûï·üí·ûë·üÅ·ûö·ûñ·û∏ "${groups[curId].name}" ·ûë·üÖ "${groups[toGroupId].name}"`,
                        'transfer',
                        toGroupId
                    );
                }
            })
            .catch((error) => {
                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç', 'error');
                console.error('Transfer error:', error);
            });
        }
        
        // Load transfer history
        function loadTransferHistory() {
            if (!curId) return;
            
            rdb.ref('transfers').orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
                const transfers = snapshot.val() || {};
                const transferList = document.getElementById('transferHistory');
                
                let html = '';
                Object.values(transfers)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .forEach(transfer => {
                        // Only show transfers related to current group
                        if (transfer.fromGroupId === curId || transfer.toGroupId === curId) {
                            const date = new Date(transfer.timestamp).toLocaleDateString('km-KH');
                            const time = new Date(transfer.timestamp).toLocaleTimeString('km-KH', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            
                            html += `
                                <div class="transfer-item">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-xs);">
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">
                                            <span class="transfer-tool">${transfer.tool}</span> √ó${transfer.quantity}
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-tertiary);">
                                            ${date} ${time}
                                        </div>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        <span class="transfer-from">${transfer.fromGroupName}</span>
                                        <i class="fas fa-arrow-right" style="margin: 0 var(--space-xs); font-size: 11px;"></i>
                                        <span class="transfer-to">${transfer.toGroupName}</span>
                                    </div>
                                    ${transfer.note ? `
                                        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: var(--space-xs);">
                                            <i class="fas fa-comment"></i> ${transfer.note}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                    });
                
                transferList.innerHTML = html || '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-lg);">·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûï·üí·ûë·üÅ·ûö</div>';
            });
        }
        
        // ============================================
        // INVENTORY MANAGEMENT FUNCTIONS
        // ============================================
        
        // Show inventory modal
        function showInventory() {
            document.getElementById('mInventory').style.display = 'block';
            updateInventoryDisplay();
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const date = document.getElementById('historyDate').value;
            
            // Calculate totals
            let totalInventory = 0;
            let inUseInventory = 0;
            let lowStockItems = [];
            
            Object.keys(masterInventory).forEach(tool => {
                totalInventory += masterInventory[tool];
            });
            
            Object.keys(groups).forEach(groupId => {
                const data = getEffectiveData(groupId, date);
                if (!data.isReturned && data.items) {
                    Object.keys(data.items).forEach(tool => {
                        inUseInventory += data.items[tool];
                        
                        // Check for low stock
                        const available = masterInventory[tool] - data.items[tool];
                        if (available <= settings.inventory.lowStockThreshold) {
                            if (!lowStockItems.find(item => item.tool === tool)) {
                                lowStockItems.push({
                                    tool: tool,
                                    available: available,
                                    total: masterInventory[tool]
                                });
                            }
                        }
                    });
                }
            });
            
            // Update summary
            document.getElementById('totalInventory').textContent = totalInventory;
            document.getElementById('inUseInventory').textContent = inUseInventory;
            document.getElementById('availableInventory').textContent = totalInventory - inUseInventory;
            
            // Update inventory list
            const inventoryList = document.getElementById('inventoryList');
            let html = '';
            
            toolsMaster.forEach(tool => {
                const toolName = tool.name;
                const stock = masterInventory[toolName] || 0;
                let used = 0;
                
                // Calculate used quantity
                Object.keys(groups).forEach(groupId => {
                    const data = getEffectiveData(groupId, date);
                    if (!data.isReturned && data.items && data.items[toolName]) {
                        used += data.items[toolName];
                    }
                });
                
                const available = stock - used;
                let stockClass = 'inventory-good';
                
                if (available <= settings.inventory.lowStockThreshold) {
                    stockClass = 'inventory-low';
                } else if (available <= settings.inventory.mediumStockThreshold) {
                    stockClass = 'inventory-medium';
                }
                
                html += `
                    <div class="ios-edit-item ${stockClass}">
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-weight: 600;">${toolName}</span>
                            <span style="font-size: 12px; color: var(--text-tertiary);">
                                ·ûü·üí·ûè·ûª·ûÄ: ${stock} | ·ûî·üí·ûö·ûæ: ${used} | ·ûì·üÖ·ûü·ûõ·üã: ${available}
                            </span>
                        </div>
                        <div class="ios-edit-controls">
                            <button class="ios-quantity-btn" onclick="adjustInventoryStock('${toolName}', -1)">-</button>
                            <span id="inv_${toolName}" class="ios-quantity-display">${stock}</span>
                            <button class="ios-quantity-btn" onclick="adjustInventoryStock('${toolName}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            
            inventoryList.innerHTML = html;
            
            // Update low stock alerts
            const lowStockAlerts = document.getElementById('lowStockAlerts');
            if (lowStockItems.length > 0) {
                let alertsHtml = '';
                lowStockItems.forEach(item => {
                    alertsHtml += `
                        <div class="ios-tool-item inventory-low">
                            <span class="ios-tool-name">${item.tool}</span>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span class="ios-tool-quantity" style="color: var(--danger);">${item.available}/${item.total}</span>
                                <span style="font-size: 11px; color: var(--text-tertiary);">
                                    ·ûì·üÖ·ûü·ûõ·üã·ûè·üí·ûö·ûπ·ûò ${item.available} ·ûÇ·üí·ûö·ûø·ûÑ
                                </span>
                            </div>
                        </div>
                    `;
                });
                lowStockAlerts.innerHTML = alertsHtml;
            } else {
                lowStockAlerts.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-lg);">·ûÇ·üí·ûò·û∂·ûì·ûß·ûî·ûÄ·ûö·ûé·üç·ûá·û∑·ûè·û¢·ûü·üã</div>';
            }
        }
        
        // Adjust inventory stock
        function adjustInventoryStock(tool, delta) {
            const element = document.getElementById('inv_' + tool);
            let current = parseInt(element.innerText);
            current = Math.max(0, current + delta);
            element.innerText = current;
            masterInventory[tool] = current;
        }
        
        // Save inventory
        function saveInventory() {
            rdb.ref('inventory').set(masterInventory)
                .then(() => {
                    showToast('·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûü·üí·ûè·ûª·ûÄ·ûß·ûî·ûÄ·ûö·ûé·üç', 'success');
                    updateInventoryDisplay();
                    
                    // Log activity
                    logActivity('UPDATE_INVENTORY', { inventory: masterInventory });
                })
                .catch((error) => {
                    showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûü·üí·ûè·ûª·ûÄ', 'error');
                    console.error('Save inventory error:', error);
                });
        }
        
        // Update all inventory from current usage
        function updateAllInventory() {
            const date = document.getElementById('historyDate').value;
            let usedTools = {};
            
            // Calculate used tools
            Object.keys(groups).forEach(groupId => {
                const data = getEffectiveData(groupId, date);
                if (!data.isReturned && data.items) {
                    Object.keys(data.items).forEach(tool => {
                        usedTools[tool] = (usedTools[tool] || 0) + data.items[tool];
                    });
                }
            });
            
            // Update master inventory to be at least used quantity + threshold
            Object.keys(usedTools).forEach(tool => {
                const currentStock = masterInventory[tool] || 0;
                const neededStock = usedTools[tool] + settings.inventory.mediumStockThreshold;
                
                if (currentStock < neededStock) {
                    masterInventory[tool] = neededStock;
                }
            });
            
            updateInventoryDisplay();
            showToast('·ûî·û∂·ûì·ûí·üí·ûú·ûæ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì·ûó·û∂·ûñ·ûü·üí·ûè·ûª·ûÄ·ûñ·û∏·ûÄ·û∂·ûö·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì', 'success');
        }
        
        // Check low stock and send notifications
        function checkLowStock() {
            const date = document.getElementById('historyDate').value;
            let lowStockItems = [];
            
            toolsMaster.forEach(tool => {
                const toolName = tool.name;
                const stock = masterInventory[toolName] || 0;
                let used = 0;
                
                // Calculate used quantity
                Object.keys(groups).forEach(groupId => {
                    const data = getEffectiveData(groupId, date);
                    if (!data.isReturned && data.items && data.items[toolName]) {
                        used += data.items[toolName];
                    }
                });
                
                const available = stock - used;
                if (available <= settings.inventory.lowStockThreshold) {
                    lowStockItems.push({
                        tool: toolName,
                        available: available,
                        total: stock
                    });
                    
                    // Send notification if enabled
                    if (settings.notifications.lowStock) {
                        // Check if notification already sent today
                        const today = new Date().toISOString().split('T')[0];
                        const notificationKey = `low_stock_${toolName}_${today}`;
                        
                        if (!localStorage.getItem(notificationKey)) {
                            createNotification(
                                '·ûß·ûî·ûÄ·ûö·ûé·üç·ûá·û∑·ûè·û¢·ûü·üã',
                                `·ûß·ûî·ûÄ·ûö·ûé·üç "${toolName}" ·ûì·üÖ·ûü·ûõ·üã·ûè·üí·ûö·ûπ·ûò ${available} ·ûÇ·üí·ûö·ûø·ûÑ (·ûü·ûö·ûª·ûî: ${stock})`,
                                'warning',
                                null
                            );
                            localStorage.setItem(notificationKey, 'sent');
                        }
                    }
                }
            });
        }
        
        // ============================================
        // NOTIFICATION SYSTEM FUNCTIONS
        // ============================================
        
        // Toggle notification panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('show');
        }
        
        // Create notification
        function createNotification(title, message, type, relatedId) {
            const notification = {
                title: title,
                message: message,
                type: type,
                relatedId: relatedId,
                read: false,
                timestamp: new Date().toISOString(),
                id: Date.now()
            };
            
            // Save to Firebase
            rdb.ref('notifications/' + notification.id).set(notification);
        }
        
        // Mark all as read
        function markAllAsRead() {
            notifications.forEach(notification => {
                rdb.ref('notifications/' + notification.id).update({ read: true });
            });
            
            updateNotificationBadge();
            showToast('·ûî·û∂·ûì·ûü·üÜ·û¢·û∂·ûè·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã', 'success');
        }
        
        // Show all notifications
        function showAllNotifications() {
            rdb.ref('notifications').once('value', (snapshot) => {
                const allNotifications = snapshot.val() || {};
                const sortedNotifications = Object.values(allNotifications)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '<div class="ios-group-list">';
                
                sortedNotifications.forEach(notification => {
                    const date = new Date(notification.timestamp).toLocaleDateString('km-KH');
                    const time = new Date(notification.timestamp).toLocaleTimeString('km-KH', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let icon = 'fas fa-bell';
                    let color = 'var(--primary)';
                    
                    switch(notification.type) {
                        case 'warning':
                            icon = 'fas fa-exclamation-triangle';
                            color = 'var(--warning)';
                            break;
                        case 'transfer':
                            icon = 'fas fa-exchange-alt';
                            color = 'var(--info)';
                            break;
                        case 'location':
                            icon = 'fas fa-map-marker-alt';
                            color = 'var(--success)';
                            break;
                    }
                    
                    html += `
                        <div class="ios-group-item ${notification.read ? '' : 'unread'}" onclick="viewNotification('${notification.id}')">
                            <div style="width: 40px; height: 40px; background: ${color}; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                                <i class="${icon}"></i>
                            </div>
                            <div class="ios-group-info">
                                <div class="ios-group-name">${notification.title}</div>
                                <div class="ios-group-status" style="font-size: 13px; color: var(--text-secondary);">
                                    ${notification.message}
                                </div>
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                                    ${date} ${time}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('allNotifications').innerHTML = html;
                document.getElementById('mNotifications').style.display = 'block';
            });
        }
        
        // View notification
        function viewNotification(notificationId) {
            rdb.ref('notifications/' + notificationId).once('value', (snapshot) => {
                const notification = snapshot.val();
                if (notification) {
                    // Mark as read
                    rdb.ref('notifications/' + notificationId).update({ read: true });
                    
                    // If related to a group, open that group
                    if (notification.relatedId) {
                        openG(notification.relatedId);
                    }
                    
                    closeM('mNotifications');
                }
            });
        }
        
        // ============================================
        // AUDIT LOG FUNCTIONS
        // ============================================
        
        // Log activity
        function logActivity(action, details) {
            const logEntry = {
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform
            };
            
            // Save to Firebase
            rdb.ref('audit_logs/' + Date.now()).set(logEntry);
        }
        
        // Show audit log
        function showAuditLog() {
            let html = '<div class="ios-group-list">';
            
            auditLog.slice(0, 50).forEach(log => {
                const date = new Date(log.timestamp).toLocaleDateString('km-KH');
                const time = new Date(log.timestamp).toLocaleTimeString('km-KH', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                let actionText = '';
                let icon = 'fas fa-info-circle';
                let color = 'var(--info)';
                
                switch(log.action) {
                    case 'CREATE_GROUP':
                        actionText = `·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûÄ·üí·ûö·ûª·ûò "${log.details.groupName}"`;
                        icon = 'fas fa-plus';
                        color = 'var(--success)';
                        break;
                    case 'DELETE_GROUP':
                        actionText = `·ûî·û∂·ûì·ûõ·ûª·ûî·ûÄ·üí·ûö·ûª·ûò "${log.details.groupName}"`;
                        icon = 'fas fa-trash';
                        color = 'var(--danger)';
                        break;
                    case 'UPDATE_LOCATION':
                        actionText = `·ûî·û∂·ûì·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûÄ·üí·ûö·ûª·ûò "${log.details.groupName}"`;
                        icon = 'fas fa-map-marker-alt';
                        color = 'var(--primary)';
                        break;
                    case 'TRANSFER_TOOL':
                        actionText = `·ûî·û∂·ûì·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç "${log.details.tool}" (${log.details.quantity} ·ûÇ·üí·ûö·ûø·ûÑ) ·ûñ·û∏ "${log.details.fromGroupName}" ·ûë·üÖ "${log.details.toGroupName}"`;
                        icon = 'fas fa-exchange-alt';
                        color = 'var(--warning)';
                        break;
                    case 'UPDATE_INVENTORY':
                        actionText = '·ûî·û∂·ûì·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûü·üí·ûè·ûª·ûÄ·ûß·ûî·ûÄ·ûö·ûé·üç';
                        icon = 'fas fa-boxes';
                        color = 'var(--digital)';
                        break;
                    default:
                        actionText = log.action;
                }
                
                html += `
                    <div class="ios-group-item">
                        <div style="width: 40px; height: 40px; background: ${color}; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                            <i class="${icon}"></i>
                        </div>
                        <div class="ios-group-info">
                            <div class="ios-group-name">${actionText}</div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">
                                ${date} ${time} | ${log.platform}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('auditLogContent').innerHTML = html;
            document.getElementById('mAuditLog').style.display = 'block';
        }
        
        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================
        
        // Show settings modal
        function showSettings() {
            const settingsContent = document.getElementById('settingsContent');
            
            let html = `
                <div class="ios-card">
                    <div class="ios-card-content">
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-language"></i>
                                ·ûó·û∂·ûü·û∂
                            </div>
                            <select id="languageSelect" class="ios-form-input" onchange="changeSetting('language', this.value)">
                                <option value="km" ${settings.language === 'km' ? 'selected' : ''}>·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö</option>
                                <option value="en" ${settings.language === 'en' ? 'selected' : ''}>English</option>
                            </select>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-palette"></i>
                                ·ûî·üí·ûö·ûó·üÅ·ûë·ûñ·ûé·üå
                            </div>
                            <select id="themeSelect" class="ios-form-input" onchange="changeSetting('theme', this.value)">
                                <option value="auto" ${settings.theme === 'auto' ? 'selected' : ''}>·ûü·üí·ûú·üê·ûô·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑</option>
                                <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>·ûñ·ûì·üí·ûõ·û∫</option>
                                <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>·ûÑ·ûÑ·ûπ·ûè</option>
                            </select>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-bell"></i>
                                ·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                <label style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="checkbox" id="notifLowStock" ${settings.notifications.lowStock ? 'checked' : ''} onchange="changeNotificationSetting('lowStock', this.checked)">
                                    <span>·ûß·ûî·ûÄ·ûö·ûé·üç·ûá·û∑·ûè·û¢·ûü·üã</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="checkbox" id="notifOverdue" ${settings.notifications.overdue ? 'checked' : ''} onchange="changeNotificationSetting('overdue', this.checked)">
                                    <span>·ûß·ûî·ûÄ·ûö·ûé·üç·û†·ûΩ·ûü·ûÄ·üÜ·ûé·ûè·üã</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="checkbox" id="notifTransfer" ${settings.notifications.transfer ? 'checked' : ''} onchange="changeNotificationSetting('transfer', this.checked)">
                                    <span>·ûÄ·û∂·ûö·ûï·üí·ûë·üÅ·ûö·ûß·ûî·ûÄ·ûö·ûé·üç</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="checkbox" id="notifLocation" ${settings.notifications.location ? 'checked' : ''} onchange="changeNotificationSetting('location', this.checked)">
                                    <span>·ûÄ·û∂·ûö·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûë·û∏·ûè·û∂·üÜ·ûÑ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-box"></i>
                                ·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã·ûë·ûº·ûë·üÖ
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>·ûñ·üí·ûö·üÜ·ûä·üÇ·ûì·ûü·üí·ûè·ûª·ûÄ·ûë·û∂·ûî</span>
                                    <input type="number" id="lowStockThreshold" value="${settings.inventory.lowStockThreshold}" min="1" max="100" style="width: 80px; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-medium);" onchange="changeInventorySetting('lowStockThreshold', this.value)">
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>·ûñ·üí·ûö·üÜ·ûä·üÇ·ûì·ûü·üí·ûè·ûª·ûÄ·ûò·ûí·üí·ûô·ûò</span>
                                    <input type="number" id="mediumStockThreshold" value="${settings.inventory.mediumStockThreshold}" min="1" max="100" style="width: 80px; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-medium);" onchange="changeInventorySetting('mediumStockThreshold', this.value)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-database"></i>
                                ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                                <button class="ios-btn ios-btn-secondary" onclick="backupData()">
                                    <i class="fas fa-save"></i>
                                    ·ûî·ûò·üí·ûö·ûª·ûÑ·ûë·ûª·ûÄ
                                </button>
                                <button class="ios-btn ios-btn-secondary" onclick="restoreData()">
                                    <i class="fas fa-undo"></i>
                                    ·ûü·üí·ûä·û∂·ûö
                                </button>
                                <button class="ios-btn ios-btn-secondary" onclick="exportAllData()">
                                    <i class="fas fa-file-export"></i>
                                    ·ûì·û∂·üÜ·ûÖ·üÅ·ûâ
                                </button>
                                <button class="ios-btn ios-btn-danger" onclick="clearLocalData()">
                                    <i class="fas fa-trash"></i>
                                    ·ûü·üÜ·û¢·û∂·ûè
                                </button>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-shield-alt"></i>
                                ·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                <label style="display: flex; align-items: center; gap: var(--space-sm);">
                                    <input type="checkbox" id="requirePin" ${settings.security.requirePin ? 'checked' : ''} onchange="changeSecuritySetting('requirePin', this.checked)">
                                    <span>·ûë·û∂·ûò·ûë·û∂·ûö PIN</span>
                                </label>
                                ${settings.security.requirePin ? `
                                    <button class="ios-btn ios-btn-secondary" onclick="changePIN()">
                                        <i class="fas fa-key"></i>
                                        ·ûî·üí·ûè·ûº·ûö PIN
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <div class="settings-section-title">
                                <i class="fas fa-info-circle"></i>
                                ·ûñ·üê·ûè·üå·ûò·û∂·ûì
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">
                                <div style="margin-bottom: var(--space-sm);">
                                    <strong>·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç</strong><br>
                                    ·ûÄ·üÜ·ûé·üÇ 2.0.0
                                </div>
                                <div>
                                    <strong>·ûî·ûÑ·üí·ûÄ·ûæ·ûè·û°·ûæ·ûÑ·ûä·üÑ·ûô:</strong><br>
                                    ·ûÄ·üí·ûö·ûª·ûò·û¢·ûó·û∑·ûú·ûå·üí·ûç·ûì·üç
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            settingsContent.innerHTML = html;
            document.getElementById('mSettings').style.display = 'block';
        }
        
        // Change setting
        function changeSetting(key, value) {
            settings[key] = value;
            if (key === 'theme') {
                applyTheme(value);
            }
        }
        
        // Change notification setting
        function changeNotificationSetting(key, value) {
            settings.notifications[key] = value;
        }
        
        // Change inventory setting
        function changeInventorySetting(key, value) {
            settings.inventory[key] = parseInt(value);
        }
        
        // Change security setting
        function changeSecuritySetting(key, value) {
            settings.security[key] = value;
        }
        
        // Change PIN
        function changePIN() {
            const newPin = prompt('·ûî·ûâ·üí·ûÖ·ûº·ûõ PIN ·ûê·üí·ûò·û∏ (·ûõ·üÅ·ûÅ 4-6 ·ûÅ·üí·ûë·ûÑ·üã):');
            if (newPin && /^\d{4,6}$/.test(newPin)) {
                settings.security.pin = newPin;
                showToast('·ûî·û∂·ûì·ûî·üí·ûè·ûº·ûö PIN ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
            }
        }
        
        // Backup data
        function backupData() {
            const backup = {
                groups: groups,
                records: records,
                inventory: masterInventory,
                settings: settings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tool-management-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('·ûî·û∂·ûì·ûî·ûò·üí·ûö·ûª·ûÑ·ûë·ûª·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô', 'success');
        }
        
        // Restore data
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (confirm('·ûè·ûæ·û¢·üí·ûì·ûÄ·ûñ·û∑·ûè·ûá·û∂·ûÖ·ûÑ·üã·ûü·üí·ûä·û∂·ûö·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûò·üÇ·ûì·ûë·üÅ? ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì·ûì·ûπ·ûÑ·ûè·üí·ûö·ûº·ûú·ûõ·ûª·ûî·üî')) {
                            // Restore data to Firebase
                            Promise.all([
                                rdb.ref('groups').set(backup.groups || {}),
                                rdb.ref('daily_records').set(backup.records || {}),
                                rdb.ref('inventory').set(backup.inventory || {})
                            ]).then(() => {
                                // Restore settings
                                if (backup.settings) {
                                    settings = backup.settings;
                                    localStorage.setItem('app_settings', JSON.stringify(settings));
                                }
                                
                                showToast('·ûî·û∂·ûì·ûü·üí·ûä·û∂·ûö·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                                refreshAll();
                            }).catch(error => {
                                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûü·üí·ûä·û∂·ûö·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô', 'error');
                                console.error('Restore error:', error);
                            });
                        }
                    } catch (error) {
                        showToast('·ûØ·ûÄ·ûü·û∂·ûö·ûî·ûò·üí·ûö·ûª·ûÑ·ûë·ûª·ûÄ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Export all data
        function exportAllData() {
            const date = document.getElementById('historyDate').value;
            const exportData = {
                summary: {
                    date: date,
                    totalGroups: Object.keys(groups).length,
                    totalTools: calculateTotalTools()
                },
                groups: {},
                inventory: masterInventory,
                settings: settings,
                exportDate: new Date().toISOString()
            };
            
            // Add group details
            Object.keys(groups).forEach(groupId => {
                const data = getEffectiveData(groupId, date);
                exportData.groups[groupId] = {
                    name: groups[groupId].name,
                    items: data.items || {},
                    isReturned: data.isReturned,
                    location: groups[groupId].location || null
                };
            });
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tool-management-export-${date}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô', 'success');
        }
        
        // Clear local data
        function clearLocalData() {
            if (confirm('·ûè·ûæ·û¢·üí·ûì·ûÄ·ûñ·û∑·ûè·ûá·û∂·ûÖ·ûÑ·üã·ûü·üÜ·û¢·û∂·ûè·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûò·ûº·ûõ·ûä·üí·ûã·û∂·ûì·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã·ûò·üÇ·ûì·ûë·üÅ? ·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ·ûì·üÅ·üá·ûò·û∑·ûì·û¢·û∂·ûÖ·ûè·üí·ûö·û°·ûî·üã·ûú·û∑·ûâ·ûî·û∂·ûì·ûë·üÅ·üî')) {
                localStorage.clear();
                showToast('·ûî·û∂·ûì·ûü·üÜ·û¢·û∂·ûè·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûò·ûº·ûõ·ûä·üí·ûã·û∂·ûì', 'success');
                location.reload();
            }
        }
        
        // Calculate total tools
        function calculateTotalTools() {
            let total = 0;
            toolsMaster.forEach(tool => {
                total += masterInventory[tool.name] || 0;
            });
            return total;
        }
        
        // ============================================
        // OFFLINE SUPPORT
        // ============================================
        
        function setupOfflineSupport() {
            // Check online status
            window.addEventListener('online', () => {
                showToast('·ûî·û∂·ûì·ûè·ûó·üí·ûá·û∂·ûî·üã·û¢·üä·û∏·ûì·ûí·û∫·ûé·û∑·ûè·û°·ûæ·ûÑ·ûú·û∑·ûâ', 'success');
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                showToast('·ûî·û∂·ûì·ûñ·üí·ûô·ûΩ·ûö·ûÄ·û∂·ûö·ûè·ûó·üí·ûá·û∂·ûî·üã ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûì·ûπ·ûÑ·ûè·üí·ûö·ûº·ûú·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûÄ·üí·ûì·ûª·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç', 'warning');
            });
        }
        
        function syncOfflineData() {
            // In a real app, this would sync local changes with Firebase
            console.log('Syncing offline data...');
        }
        
        // ============================================
        // TOOL HISTORY FUNCTIONS
        // ============================================
        
        // Show tool history
        function showToolHistory() {
            if (!curId) return;
            
            const date = document.getElementById('historyDate').value;
            const groupName = groups[curId].name;
            let html = `
                <div class="ios-card">
                    <div class="ios-card-content">
                        <h3 style="color: var(--primary); margin-bottom: var(--space-md);">
                            <i class="fas fa-history"></i> ·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûß·ûî·ûÄ·ûö·ûé·üç - ${groupName}
                        </h3>
            `;
            
            // Get all dates with records for this group
            const groupRecords = {};
            Object.keys(records).forEach(recordDate => {
                if (records[recordDate] && records[recordDate][curId]) {
                    groupRecords[recordDate] = records[recordDate][curId];
                }
            });
            
            // Sort dates in descending order
            const sortedDates = Object.keys(groupRecords).sort().reverse();
            
            if (sortedDates.length === 0) {
                html += `
                    <div class="ios-empty-state">
                        <div class="ios-empty-icon"><i class="fas fa-history"></i></div>
                        <p>·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûß·ûî·ûÄ·ûö·ûé·üç</p>
                    </div>
                `;
            } else {
                html += '<div class="ios-group-list">';
                
                sortedDates.slice(0, 10).forEach(recordDate => {
                    const data = groupRecords[recordDate];
                    const formattedDate = new Date(recordDate).toLocaleDateString('km-KH', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    html += `
                        <div class="ios-group-item">
                            <div style="width: 40px; height: 40px; background: ${data.isReturned ? 'var(--success)' : 'var(--primary)'}; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                                <i class="fas ${data.isReturned ? 'fa-check' : 'fa-tools'}"></i>
                            </div>
                            <div class="ios-group-info">
                                <div class="ios-group-name">${formattedDate}</div>
                                <div class="ios-group-status" style="color: ${data.isReturned ? 'var(--success)' : 'var(--primary)'};">
                                    ${data.isReturned ? '‚úÖ ·ûü·ûÑ·ûö·ûΩ·ûÖ' : 'üïí ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ'}
                                </div>
                                ${Object.keys(data.items || {}).length > 0 ? `
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                        ${Object.keys(data.items || {}).map(tool => `${tool}: ${data.items[tool]}`).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('toolHistoryContent').innerHTML = html;
            document.getElementById('mToolHistory').style.display = 'block';
        }
        
        // ============================================
        // VIEW ALL LOCATIONS
        // ============================================
        
        // Show all locations
        function showAllLocations() {
            const locations = [];
            
            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];
                if (group.location) {
                    locations.push({
                        groupId: groupId,
                        groupName: group.name,
                        location: group.location
                    });
                }
            });
            
            if (locations.length === 0) {
                showToast('·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûÄ·üí·ûö·ûª·ûò·ûé·û∂·ûò·ûΩ·ûô·ûò·û∂·ûì·ûë·û∏·ûè·û∂·üÜ·ûÑ', 'info');
                return;
            }
            
            let html = '<div class="ios-group-list">';
            
            locations.forEach(loc => {
                const mapsUrl = loc.location.lat && loc.location.lng 
                    ? `https://www.google.com/maps?q=${loc.location.lat},${loc.location.lng}`
                    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.location.name)}`;
                
                html += `
                    <div class="ios-group-item" onclick="openG('${loc.groupId}')">
                        <div class="ios-group-info">
                            <div class="ios-group-name">${loc.groupName}</div>
                            <div class="ios-group-status">
                                <i class="fas fa-map-marker-alt"></i>
                                ${loc.location.name}
                            </div>
                            ${loc.location.lat && loc.location.lng ? `
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    ${loc.location.lat.toFixed(6)}, ${loc.location.lng.toFixed(6)}
                                </div>
                            ` : ''}
                        </div>
                        <a href="${mapsUrl}" target="_blank" class="ios-group-arrow">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('allLocationsList').innerHTML = html;
            document.getElementById('mAllLocations').style.display = 'block';
        }
        
        // ============================================
        // EXISTING FUNCTIONS (Updated)
        // ============================================
        
        // Scroll to top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Switch tab
        function switchTab(tabName) {
            // Update tab bar
            document.querySelectorAll('.ios-tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // For now, just scroll to top for home tab
            if (tabName === 'home') {
                scrollToTop();
            } else if (tabName === 'groups') {
                // In a full implementation, this would show groups view
                document.getElementById('gName').focus();
            }
        }
        
        // Search for a specific tool
        function searchTool(toolName) {
            document.getElementById('globalSearch').value = toolName;
            performSearch(toolName.toLowerCase());
        }
        
        // Global search function
        function handleGlobalSearch(event) {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('globalSearch').value.trim().toLowerCase();
                
                if (searchTerm === '') {
                    closeM('mSearch');
                    return;
                }
                
                performSearch(searchTerm);
            }, 300);
        }
        
        // Perform search
        function performSearch(searchTerm) {
            const date = document.getElementById('historyDate').value;
            const results = {
                tools: [],
                groups: []
            };
            
            // Search for tools
            const toolResults = {};
            toolsMaster.forEach(tool => {
                if (tool.name.toLowerCase().includes(searchTerm)) {
                    toolResults[tool.name] = { groups: [], total: 0 };
                }
            });
            
            // Search through groups
            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];
                const groupName = group.name.toLowerCase();
                const data = getEffectiveData(groupId, date);
                
                // Check if group name matches
                if (groupName.includes(searchTerm)) {
                    results.groups.push({
                        id: groupId,
                        name: group.name,
                        status: data.isReturned ? 'returned' : 'busy',
                        toolCount: Object.keys(data.items || {}).length,
                        img: group.img
                    });
                }
                
                // Check tools in this group
                Object.keys(data.items || {}).forEach(tool => {
                    if (tool.toLowerCase().includes(searchTerm)) {
                        if (!toolResults[tool]) {
                            toolResults[tool] = { groups: [], total: 0 };
                        }
                        toolResults[tool].groups.push({
                            id: groupId,
                            name: group.name,
                            quantity: data.items[tool]
                        });
                        toolResults[tool].total += data.items[tool];
                    }
                });
            });
            
            // Convert tool results to array
            Object.keys(toolResults).forEach(tool => {
                if (toolResults[tool].groups.length > 0) {
                    results.tools.push({
                        name: tool,
                        groups: toolResults[tool].groups,
                        total: toolResults[tool].total
                    });
                }
            });
            
            displaySearchResults(results);
            document.getElementById('mSearch').style.display = 'block';
        }
        
        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            let html = '';
            
            // Display tool results
            if (results.tools.length > 0) {
                html += `<div style="margin-bottom: var(--space-2xl);">
                            <div style="font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: var(--space-md); padding-bottom: var(--space-xs); border-bottom: 2px solid var(--border-heavy);">·ûß·ûî·ûÄ·ûö·ûé·üç (${results.tools.length})</div>`;
                
                results.tools.forEach(tool => {
                    html += `<div class="ios-group-item" onclick="viewToolGroups('${tool.name}')" style="border-left-color: var(--digital);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${tool.name}</div>
                                    <div style="background: var(--primary); color: white; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">·ûü·ûö·ûª·ûî: ${tool.total}</div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); display: flex; gap: var(--space-sm);">
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <i class="fas fa-users"></i>
                                        <span>·ûÄ·üí·ûö·ûª·ûò: ${tool.groups.length}</span>
                                    </div>
                                </div>
                            </div>`;
                });
                
                html += `</div>`;
            }
            
            // Display group results
            if (results.groups.length > 0) {
                html += `<div style="margin-bottom: var(--space-2xl);">
                            <div style="font-size: 15px; font-weight: 700; color: var(--success); margin-bottom: var(--space-md); padding-bottom: var(--space-xs); border-bottom: 2px solid var(--border-heavy);">·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö (${results.groups.length})</div>`;
                
                results.groups.forEach(group => {
                    html += `<div class="ios-group-item" onclick="openG('${group.id}')" style="border-left-color: var(--success);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${group.name}</div>
                                    <div>${group.status === 'returned' ? '‚úÖ' : 'üïí'}</div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <i class="fas fa-tools"></i>
                                        <span>·ûß·ûî·ûÄ·ûö·ûé·üç: ${group.toolCount}</span>
                                    </div>
                                </div>
                            </div>`;
                });
                
                html += `</div>`;
            }
            
            // No results
            if (results.tools.length === 0 && results.groups.length === 0) {
                html = `<div class="ios-empty-state">
                            <div class="ios-empty-icon"><i class="fas fa-search"></i></div>
                            <p>·ûö·ûÄ·ûò·û∑·ûì·ûÉ·ûæ·ûâ·ûõ·ûë·üí·ûí·ûï·ûõ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûÄ·û∂·ûö·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ</p>
                            <p style="font-size: 14px; margin-top: var(--space-sm);">·ûü·ûº·ûò·ûñ·üí·ûô·û∂·ûô·û∂·ûò·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûñ·û∂·ûÄ·üí·ûô·ûï·üí·ûü·üÅ·ûÑ·ûë·üÄ·ûè</p>
                        </div>`;
            }
            
            searchResults.innerHTML = html;
        }
        
        // View groups using a specific tool
        function viewToolGroups(toolName) {
            const date = document.getElementById('historyDate').value;
            let html = `<div>
                            <div style="font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: var(--space-md); padding-bottom: var(--space-xs); border-bottom: 2px solid var(--border-heavy);">·ûÄ·üí·ûö·ûª·ûò·ûä·üÇ·ûõ·ûî·üí·ûö·ûæ "${toolName}"</div>`;
            
            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];
                const data = getEffectiveData(groupId, date);
                
                if (data.items && data.items[toolName] > 0) {
                    html += `<div class="ios-group-item" onclick="openG('${groupId}')">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${group.name}</div>
                                    <div style="background: var(--primary); color: white; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">x${data.items[toolName]}</div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <i class="fas fa-calendar"></i>
                                        <span>·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ: ${data.isReturned ? '·ûü·ûÑ·ûö·ûΩ·ûÖ' : '·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ'}</span>
                                    </div>
                                </div>
                            </div>`;
                }
            });
            
            html += `</div>`;
            document.getElementById('searchResults').innerHTML = html;
        }
        
        // Switch search tabs
        function switchSearchTab(tab) {
            showToast('·ûò·ûª·ûÅ·ûÑ·û∂·ûö·ûì·üÅ·üá·ûì·ûπ·ûÑ·ûò·ûÄ·ûä·ûõ·üã·ûÜ·û∂·ûî·üã·üó', 'info');
        }
        
        // Toggle Return Status
        function toggleReturn() {
            const date = document.getElementById('historyDate').value;
            const data = getEffectiveData(curId, date);
            
            rdb.ref(`daily_records/${date}/${curId}`).set({
                items: data.items || {},
                isReturned: !data.isReturned
            });
            
            showToast(data.isReturned ? '·ûî·û∂·ûì·ûÄ·üÜ·ûé·ûè·üã·ûá·û∂·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûü·ûÑ·ûú·û∑·ûâ' : '·ûî·û∂·ûì·ûÄ·üÜ·ûé·ûè·üã·ûá·û∂·ûü·ûÑ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã', 'success');
            
            // Log activity
            logActivity('TOGGLE_RETURN', {
                groupId: curId,
                groupName: groups[curId].name,
                newStatus: !data.isReturned
            });
        }
        
        // Open Edit Mode
        function openEdit() {
            document.getElementById('viewMode').style.display = "none";
            document.getElementById('editMode').style.display = "block";
            
            const date = document.getElementById('historyDate').value;
            const data = getEffectiveData(curId, date);
            const editGrid = document.getElementById('editGrid');
            
            let html = '';
            toolsMaster.forEach(tool => {
                const toolName = tool.name;
                const quantity = data.items ? (data.items[toolName] || 0) : 0;
                html += `
                    <div class="ios-edit-item">
                        <span style="font-weight: 600;">${toolName}</span>
                        <div class="ios-edit-controls">
                            <button class="ios-quantity-btn" onclick="adjustQuantity('${toolName}', -1)">-</button>
                            <span id="q_${toolName}" class="ios-quantity-display">${quantity}</span>
                            <button class="ios-quantity-btn" onclick="adjustQuantity('${toolName}', 1)">+</button>
                        </div>
                    </div>
                `;
            });
            
            editGrid.innerHTML = html;
        }
        
        // Adjust Quantity in Edit Mode
        function adjustQuantity(tool, delta) {
            const element = document.getElementById('q_' + tool);
            let current = parseInt(element.innerText);
            current = Math.max(0, current + delta);
            element.innerText = current;
        }
        
        // Save Tools
        function saveTools() {
            const date = document.getElementById('historyDate').value;
            const items = {};
            
            toolsMaster.forEach(tool => {
                const toolName = tool.name;
                const quantity = parseInt(document.getElementById('q_' + toolName).innerText);
                if (quantity > 0) {
                    items[toolName] = quantity;
                }
            });
            
            rdb.ref(`daily_records/${date}/${curId}`).set({
                items: items,
                isReturned: false
            });
            
            document.getElementById('editMode').style.display = "none";
            document.getElementById('viewMode').style.display = "block";
            
            showToast('·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
            
            // Log activity
            logActivity('UPDATE_TOOLS', {
                groupId: curId,
                groupName: groups[curId].name,
                items: items
            });
        }
        
        // Show Summary
        function showSummary() {
            const date = document.getElementById('historyDate').value;
            const totals = {};
            
            for (let gid in groups) {
                const data = getEffectiveData(gid, date);
                if (!data.isReturned && data.items) {
                    for (let tool in data.items) {
                        totals[tool] = (totals[tool] || 0) + data.items[tool];
                    }
                }
            }
            
            const summaryContent = document.getElementById('summaryContent');
            
            if (Object.keys(totals).length === 0) {
                summaryContent.innerHTML = `
                    <div class="ios-empty-state">
                        <div class="ios-empty-icon"><i class="fas fa-chart-bar"></i></div>
                        <p>·ûÇ·üí·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·ûö·ûª·ûî·ûü·ûò·üí·ûö·û∂·ûî·üã·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá</p>
                        <p style="font-size: 14px; margin-top: var(--space-sm);">·ûü·ûº·ûò·ûï·üí·ûè·ûõ·üã·ûß·ûî·ûÄ·ûö·ûé·üç·ûä·ûõ·üã·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö·ûá·û∂·ûò·ûª·ûì·ûü·û∑·ûì</p>
                    </div>
                `;
            } else {
                let html = '';
                toolsMaster.forEach(tool => {
                    if (totals[tool.name] > 0) {
                        html += `
                            <div class="ios-summary-item">
                                <span>${tool.name}</span>
                                <span class="ios-summary-total">${totals[tool.name]}</span>
                            </div>
                        `;
                    }
                });
                summaryContent.innerHTML = html;
            }
            
            document.getElementById('mSummary').style.display = "block";
        }
        
        // Add New Group
        function addGroup() {
            const name = document.getElementById('gName').value.trim();
            
            if (!name) {
                showToast('·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûà·üí·ûò·üÑ·üá·ûÄ·üí·ûö·ûª·ûò', 'warning');
                document.getElementById('gName').focus();
                return;
            }
            
            const groupId = 'G' + Date.now();
            rdb.ref('groups/' + groupId).set({
                name: name,
                img: tempImg,
                createdAt: new Date().toISOString(),
                location: null
            });
            
            document.getElementById('gName').value = '';
            document.getElementById('tempImgView').src = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            tempImg = "";
            
            showToast('·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûÄ·üí·ûö·ûª·ûò·ûê·üí·ûò·û∏·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
            
            // Log activity
            logActivity('CREATE_GROUP', { groupName: name });
        }
        
        // Preview Image
        function previewImg(input) {
            if (!input.files || !input.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = 150;
                    canvas.height = 150;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 150, 150);
                    tempImg = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('tempImgView').src = tempImg;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
        
        // Send Group Data to Telegram
        async function sendGroupTelegram() {
            const date = document.getElementById('historyDate').value;
            const data = getEffectiveData(curId, date);
            
            let message = `üèóÔ∏è *·ûÄ·üí·ûö·ûª·ûò·üñ* ${groups[curId].name}\n`;
            message += `üìÖ *·ûê·üí·ûÑ·üÉ·ûë·û∏·üñ* ${date}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            if (Object.keys(data.items || {}).length === 0) {
                message += `üì≠ *·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûß·ûî·ûÄ·ûö·ûé·üç*\n`;
            } else {
                for (let tool in data.items) {
                    message += `‚Ä¢ ${tool}: *${data.items[tool]}*\n`;
                }
            }
            
            message += `\n`;
            message += data.isReturned ? `‚úÖ *·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ·üñ ·ûü·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã*` : `üïí *·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ·üñ ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã*`;
            
            // Add location if available
            if (currentLocation) {
                message += `\n\nüìç *·ûë·û∏·ûè·û∂·üÜ·ûÑ·üñ* ${currentLocation.name}`;
                
                if (currentLocation.lat && currentLocation.lng) {
                    const mapsUrl = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}&z=17`;
                    const shortUrl = `https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
                    
                    message += `\nüåê *·ûÄ·ûº·û¢·ûö·ûä·üÑ·ûì·üÅ:* ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
                    message += `\nüó∫Ô∏è *Google Maps:* ${shortUrl}`;
                } else {
                    const searchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentLocation.name)}`;
                    message += `\nüó∫Ô∏è *Google Maps:* ${searchUrl}`;
                }
            }
            
            try {
                const botToken = '8224268737:AAFhspOb3OozxmKr3INkIPhXdYmDLaJVNB8';
                const chatId = '-1003387981594';
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    showToast('·ûî·û∂·ûì·ûï·üí·ûâ·ûæ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûë·üÖ Telegram ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                } else {
                    throw new Error('Failed to send');
                }
            } catch (error) {
                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûï·üí·ûâ·ûæ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô', 'error');
                console.error('Telegram error:', error);
            }
        }
        
        // Send Full Report to Telegram
        async function sendFullTelegram() {
            const date = document.getElementById('historyDate').value;
            const totals = {};
            
            for (let gid in groups) {
                const data = getEffectiveData(gid, date);
                if (!data.isReturned && data.items) {
                    for (let tool in data.items) {
                        totals[tool] = (totals[tool] || 0) + data.items[tool];
                    }
                }
            }
            
            let message = `üìä *·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·ûö·ûª·ûî·ûÇ·üí·ûö·ûø·ûÑ·ûÖ·ûÄ·üí·ûö*\n`;
            message += `üìÖ *·ûê·üí·ûÑ·üÉ·ûë·û∏·üñ* ${date}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            let hasData = false;
            toolsMaster.forEach(tool => {
                if (totals[tool.name] > 0) {
                    message += `üîπ *${tool.name}*: ${totals[tool.name]}\n`;
                    hasData = true;
                }
            });
            
            if (!hasData) {
                message += `üì≠ *·ûÇ·üí·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·ûö·ûª·ûî·ûü·ûò·üí·ûö·û∂·ûî·üã·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá*\n`;
            }
            
            try {
                const botToken = '8224268737:AAFhspOb3OozxmKr3INkIPhXdYmDLaJVNB8';
                const chatId = '-1003387981594';
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    showToast('·ûî·û∂·ûì·ûï·üí·ûâ·ûæ·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûë·üÖ Telegram ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                } else {
                    throw new Error('Failed to send');
                }
            } catch (error) {
                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûï·üí·ûâ·ûæ·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç', 'error');
                console.error('Telegram error:', error);
            }
        }
        
        // Export search results
        function exportSearchResults() {
            const searchTerm = document.getElementById('globalSearch').value;
            const date = document.getElementById('historyDate').value;
            
            let message = `üîç *·ûõ·ûë·üí·ûí·ûï·ûõ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ:* ${searchTerm}\n`;
            message += `üìÖ *·ûê·üí·ûÑ·üÉ·ûë·û∏:* ${date}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            // Get all result items
            const toolItems = document.querySelectorAll('.ios-group-item[style*="border-left-color: var(--digital)"]');
            const groupItems = document.querySelectorAll('.ios-group-item[style*="border-left-color: var(--success)"]');
            
            if (toolItems.length > 0) {
                message += `*·ûß·ûî·ûÄ·ûö·ûé·üç:*\n`;
                toolItems.forEach(item => {
                    const toolName = item.querySelector('div:nth-child(1) > div:nth-child(1)').textContent;
                    const total = item.querySelector('div:nth-child(1) > div:nth-child(2)').textContent.replace('·ûü·ûö·ûª·ûî: ', '');
                    message += `‚Ä¢ ${toolName}: ${total}\n`;
                });
                message += `\n`;
            }
            
            if (groupItems.length > 0) {
                message += `*·ûÄ·üí·ûö·ûª·ûò·ûÄ·û∂·ûö·ûÑ·û∂·ûö:*\n`;
                groupItems.forEach(item => {
                    const groupName = item.querySelector('div:nth-child(1) > div:nth-child(1)').textContent;
                    message += `‚Ä¢ ${groupName}\n`;
                });
            }
            
            sendTelegramMessage(message);
        }
        
        // Send Telegram message
        async function sendTelegramMessage(message) {
            try {
                const botToken = '8224268737:AAFhspOb3OozxmKr3INkIPhXdYmDLaJVNB8';
                const chatId = '-1003387981594';
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    showToast('·ûî·û∂·ûì·ûï·üí·ûâ·ûæ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûë·üÖ Telegram ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                } else {
                    throw new Error('Failed to send');
                }
            } catch (error) {
                showToast('·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûï·üí·ûâ·ûæ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô', 'error');
                console.error('Telegram error:', error);
            }
        }
        
        // Delete Group
        function delG() {
            if (confirm(`·ûè·ûæ·û¢·üí·ûì·ûÄ·ûñ·û∑·ûè·ûá·û∂·ûÖ·ûÑ·üã·ûõ·ûª·ûî·ûÄ·üí·ûö·ûª·ûò "${groups[curId].name}" ·ûò·üÇ·ûì·ûë·üÅ?`)) {
                rdb.ref('groups/' + curId).remove();
                closeM('mDetails');
                showToast('·ûî·û∂·ûì·ûõ·ûª·ûî·ûÄ·üí·ûö·ûª·ûò·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô', 'success');
                
                // Log activity
                logActivity('DELETE_GROUP', { 
                    groupId: curId, 
                    groupName: groups[curId].name 
                });
            }
        }
        
        // Close Modal
        function closeM(modalId) {
            document.getElementById(modalId).style.display = "none";
            if (modalId === 'mDetails') {
                curId = null;
                currentLocation = null;
                locationMapUrl = "";
                locationShareText = "";
            }
        }
        
        // Show Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `ios-toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Get Toast Icon
        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }
        
        // Export data in various formats
        function exportData(format) {
            const date = document.getElementById('historyDate').value;
            
            if (format === 'csv') {
                exportToCSV(date);
            } else if (format === 'excel') {
                exportToExcel(date);
            } else if (format === 'pdf') {
                exportToPDF(date);
            } else {
                showToast('·ûë·üí·ûö·ûÑ·üã·ûë·üí·ûö·û∂·ûô·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú', 'error');
            }
        }
        
        // Export to CSV
        function exportToCSV(date) {
            let csvContent = "·ûê·üí·ûÑ·üÉ·ûë·û∏,·ûÄ·üí·ûö·ûª·ûò,·ûß·ûî·ûÄ·ûö·ûé·üç,·ûÖ·üÜ·ûì·ûΩ·ûì,·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ,·ûë·û∏·ûè·û∂·üÜ·ûÑ\n";
            
            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];
                const data = getEffectiveData(groupId, date);
                
                if (Object.keys(data.items || {}).length > 0) {
                    Object.keys(data.items).forEach(tool => {
                        csvContent += `${date},"${group.name}","${tool}",${data.items[tool]},"${data.isReturned ? '·ûü·ûÑ·ûö·ûΩ·ûÖ' : '·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ'}","${group.location ? group.location.name : '·ûò·û∑·ûì·ûò·û∂·ûì'}"\n`;
                    });
                } else {
                    csvContent += `${date},"${group.name}","·ûò·û∑·ûì·ûò·û∂·ûì",0,"${data.isReturned ? '·ûü·ûÑ·ûö·ûΩ·ûÖ' : '·ûë·üÜ·ûì·üÅ·ûö'}","${group.location ? group.location.name : '·ûò·û∑·ûì·ûò·û∂·ûì'}"\n`;
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `tool-management-${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûë·üÖ·ûá·û∂ CSV', 'success');
        }
        
        // Export to Excel (simplified - in real app use a library)
        function exportToExcel(date) {
            exportToCSV(date); // For simplicity, just export as CSV
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûë·üÖ·ûá·û∂ Excel', 'success');
        }
        
        // Export to PDF (simplified - in real app use a library)
        function exportToPDF(date) {
            showToast('·ûò·ûª·ûÅ·ûÑ·û∂·ûö·ûì·û∂·üÜ·ûÖ·üÅ·ûâ PDF ·ûì·ûπ·ûÑ·ûò·ûÄ·ûä·ûõ·üã·ûÜ·û∂·ûî·üã·üó', 'info');
        }
        
        // Export inventory
        function exportInventory() {
            const dataStr = JSON.stringify(masterInventory, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tool-inventory-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûü·üí·ûè·ûª·ûÄ·ûß·ûî·ûÄ·ûö·ûé·üç', 'success');
        }
        
        // Export locations
        function exportLocations() {
            const locations = [];
            
            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];
                if (group.location) {
                    locations.push({
                        group: group.name,
                        location: group.location.name,
                        coordinates: group.location.lat && group.location.lng ? 
                            `${group.location.lat}, ${group.location.lng}` : '·ûò·û∑·ûì·ûò·û∂·ûì',
                        mapsUrl: group.location.mapsUrl || '·ûò·û∑·ûì·ûò·û∂·ûì'
                    });
                }
            });
            
            const dataStr = JSON.stringify(locations, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tool-locations-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûë·û∏·ûè·û∂·üÜ·ûÑ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã', 'success');
        }
        
        // Export audit log
        function exportAuditLog() {
            const dataStr = JSON.stringify(auditLog, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `audit-log-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('·ûî·û∂·ûì·ûì·û∂·üÜ·ûÖ·üÅ·ûâ·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ', 'success');
        }
        
        // Send notification report
        function sendNotificationReport() {
            let message = `üîî *·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ*\n`;
            message += `üìÖ *·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë:* ${new Date().toLocaleDateString('km-KH')}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            if (notifications.length === 0) {
                message += `üì≠ *·ûÇ·üí·ûò·û∂·ûì·ûÄ·û∂·ûö·ûá·ûº·ûì·ûä·üÜ·ûé·ûπ·ûÑ·ûê·üí·ûò·û∏*\n`;
            } else {
                notifications.slice(0, 10).forEach(notification => {
                    const date = new Date(notification.timestamp).toLocaleDateString('km-KH');
                    message += `‚Ä¢ ${notification.title}: ${notification.message} (${date})\n`;
                });
                
                if (notifications.length > 10) {
                    message += `\n... ·ûì·û∑·ûÑ ${notifications.length - 10} ·ûï·üí·ûü·üÅ·ûÑ·ûë·üÄ·ûè`;
                }
            }
            
            sendTelegramMessage(message);
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>