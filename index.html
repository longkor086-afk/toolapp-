<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á§á”á€ášááŸáŸáŸ†áá„áŸ‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #60a5fa;
            --bg-color: #f0f2f5;
            --white: #ffffff;
            --shadow: 10px 10px 20px #d1d9e6, -10px -10px 20px #ffffff;
            --inner-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }

        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Modern Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            padding: 22px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }

        .header-title {
            font-weight: 800;
            font-size: 20px;
            background: linear-gradient(90deg, #1e40af, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container { padding: 25px 15px; max-width: 600px; margin: 0 auto; }

        /* Premium Card */
        .card-luxury {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 28px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .input-luxury {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 18px;
            background: #f8fafc;
            box-shadow: var(--inner-shadow);
            outline: none;
            font-family: inherit;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-size: 16px;
            transition: 0.3s;
        }

        /* 3D Premium Button */
        .btn-luxury {
            border: none;
            border-radius: 18px;
            padding: 14px 24px;
            background: var(--primary);
            color: white;
            font-weight: 700;
            box-shadow: 0 8px 15px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-luxury:hover { transform: translateY(-2px); box-shadow: 0 12px 20px rgba(37, 99, 235, 0.4); }
        .btn-luxury:active { transform: translateY(0); }

        /* Group List Card */
        .group-item {
            background: white;
            padding: 18px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            box-shadow: var(--shadow);
            border: 1px solid transparent;
            transition: 0.3s;
        }

        .group-item:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }

        .img-box {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            object-fit: cover;
            margin-right: 18px;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Full Glass Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.8);
            backdrop-filter: blur(20px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content { height: 100%; overflow-y: auto; padding: 30px 20px; box-sizing: border-box; }

        .tool-card {
            background: white;
            padding: 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        .qty-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f1f5f9;
            padding: 6px;
            border-radius: 14px;
        }

        .btn-round {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: none;
            background: white;
            color: var(--primary);
            font-weight: 800;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; flex-direction: column; justify-content: center; align-items: center;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <p style="margin-top:15px; font-weight:600; color:var(--primary);">á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš...</p>
</div>

<div class="header">
    <div class="header-title">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á§á”á€ášááŸáŸáŸ†áá„áŸ‹</div>
    <div style="background: white; width: 42px; height: 42px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow);">ğŸ’</div>
</div>

<div class="container">
    <div class="card-luxury">
        <input type="text" id="gName" class="input-luxury" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á€áŸ’ášá»á˜á€á˜áŸ’á˜á€áš...">
        <div style="display: flex; gap: 15px;">
            <button class="btn-luxury" style="background:#fff; color:#444; width: 65px;" onclick="document.getElementById('gImgIn').click()">ğŸ“·</button>
            <button class="btn-luxury" style="flex:1;" onclick="addGroup()">+ á”á„áŸ’á€á¾áá€áŸ’ášá»á˜</button>
        </div>
        <input type="file" id="gImgIn" style="display:none" accept="image/*" onchange="compressImage(this, 'group')">
    </div>
    <div id="gList"></div>
</div>

<div id="mApp" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <button class="btn-round" onclick="closeM()" style="width:45px; height:45px; font-size:20px;">ğŸ”™</button>
            <h2 id="mTitle" style="margin:0; font-size: 22px; font-weight: 800;"></h2>
            <button class="btn-round" onclick="delG()" style="width:45px; height:45px; color:#ef4444;">ğŸ—‘ï¸</button>
        </div>

        <div id="viewMode">
            <button class="btn-luxury" style="width:100%; background:#334155; margin-bottom: 25px;" onclick="openEdit()">âš™ï¸ ášáŸ€á”á…áŸ†á”á‰áŸ’á‡á¸á§á”á€ášááŸ</button>
            <div style="background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                <h4 style="margin: 0 0 15px 0; color: #64748b; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">á”á‰áŸ’á‡á¸áŸá„áŸ’ááŸá”</h4>
                <div id="sumBox"></div>
            </div>
            <button class="btn-luxury" style="width:100%; background: linear-gradient(135deg, #059669, #10b981); margin-top: 30px; height: 62px; font-size: 18px;" onclick="send()">ğŸš€ á•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸ</button>
        </div>

        <div id="editMode" style="display:none;">
            <div id="tGrid"></div>
            <button class="btn-luxury" style="width:100%; margin-top: 25px; height: 58px;" onclick="closeEdit()">âœ… ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™</button>
        </div>
    </div>
    <input type="file" id="tImgIn" style="display:none" accept="image/*" onchange="compressImage(this, 'tool')">
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIDnykmBq9wWb-9isKJiji4TgIBwHQ-ZA",
      authDomain: "toolmanagement-2f44d.firebaseapp.com",
      projectId: "toolmanagement-2f44d",
      storageBucket: "toolmanagement-2f44d.firebasestorage.app",
      messagingSenderId: "129733304906",
      appId: "1:129733304906:web:4aa3ba7f223a568b343cb3",
      databaseURL: "https://toolmanagement-2f44d-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const rdb = firebase.database();

    const TOKEN = "8224268737:AAFhspOb3OozxmKr3INkIPhXdYmDLaJVNB8";
    const G_ID = "-1003387981594";
    const A_ID = "6109968412";

    let db = [];
    let curI = null, curT = null, tempImg = "";
    const toolsMaster = [{n: "á˜áŸ‰á¼á‘áŸášá”á»á€á’áŸ†", e: "ğŸ”¨"}, {n: "á˜áŸ‰á¼á‘áŸášá”á»á€áá¼á…", e: "â›ï¸"}, {n: "á˜áŸ‰á¼á‘áŸášá€á¶ááŸ‹á’áŸ†", e: "âš™ï¸"}, {n: "á˜áŸ‰á¼á‘áŸášá€á¶ááŸ‹áá¼á…", e: "âœ‚ï¸"}, {n: "áŠáŸ‚á€ááŸ’á”áŸ‚á„", e: "â›“ï¸"}, {n: "áá¶áŸáŸáŸ‡", e: "ğŸ"}, {n: "á”áŸ‰áŸ‚á›", e: "ğŸ¥„"}, {n: "á…á”", e: "âš’ï¸"}, {n: "á€á¶áœ", e: "ğŸ§ª"}, {n: "ášáá¶", e: "ğŸªš"}, {n: "ášá‘áŸáŸ‡", e: "ğŸ›’"}];

    rdb.ref('construction_tools').on('value', (snapshot) => {
        db = snapshot.val() || [];
        renderG();
        if(curI !== null && db[curI]) {
            document.getElementById('mTitle').innerText = db[curI].name;
            updateSumBox();
        }
    });

    function save() { rdb.ref('construction_tools').set(db); }

    function compressImage(input, type) {
        if (!input.files[0]) return;
        document.getElementById('loader').style.display = 'flex';
        const reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 300; let w = img.width, h = img.height;
                if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                const b64 = canvas.toDataURL('image/jpeg', 0.5);
                if(type === 'group') tempImg = b64;
                else if(type === 'tool') { db[curI].tools[curT].img = b64; renderEdit(); save(); }
                document.getElementById('loader').style.display = 'none';
            };
        };
    }

    function addGroup() {
        let n = document.getElementById('gName').value;
        if(!n) return;
        db.push({ name: n, img: tempImg, tools: toolsMaster.map(t => ({ name: t.n, emoji: t.e, qty: 0, img: "" })) });
        tempImg = ""; document.getElementById('gName').value = "";
        save();
    }

    function renderG() {
        let h = '';
        db.forEach((g, i) => {
            h += `<div class="group-item" onclick="openM(${i})">
                    <img src="${g.img || 'https://via.placeholder.com/60?text=ğŸ‘·'}" class="img-box">
                    <div style="flex:1">
                        <div style="font-weight:700; font-size:17px; margin-bottom:4px;">${g.name}</div>
                        <div style="font-size:12px; color:#94a3b8;">Sync áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·</div>
                    </div>
                    <div class="btn-round" style="width:32px; height:32px; font-size:12px;">â¯</div>
                  </div>`;
        });
        document.getElementById('gList').innerHTML = h;
    }

    function openM(i) { curI = i; document.getElementById('mTitle').innerText = db[i].name; document.getElementById('mApp').style.display = "block"; closeEdit(); }
    function openEdit() { document.getElementById('viewMode').style.display = "none"; document.getElementById('editMode').style.display = "block"; renderEdit(); }
    function renderEdit() {
        let h = '';
        db[curI].tools.forEach((t, ti) => {
            h += `<div class="tool-card">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${t.img || 'https://via.placeholder.com/45?text=ğŸ“·'}" style="width:48px; height:48px; border-radius:14px; object-fit:cover;" onclick="curT=${ti}; document.getElementById('tImgIn').click()">
                        <span style="font-weight:600; font-size:15px;">${t.emoji} ${t.name}</span>
                    </div>
                    <div class="qty-box">
                        <button class="btn-round" onclick="change(${ti},-1)">-</button>
                        <b style="min-width:24px; text-align:center; font-size:17px;">${t.qty}</b>
                        <button class="btn-round" onclick="change(${ti},1)">+</button>
                    </div>
                  </div>`;
        });
        document.getElementById('tGrid').innerHTML = h;
    }

    function change(ti, d) { db[curI].tools[ti].qty = Math.max(0, db[curI].tools[ti].qty + d); renderEdit(); }
    function closeEdit() { document.getElementById('editMode').style.display = "none"; document.getElementById('viewMode').style.display = "block"; updateSumBox(); save(); }

    function updateSumBox() {
        let h = '', has = false;
        db[curI].tools.forEach(t => { if(t.qty > 0) { h += `<div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #f1f5f9;"><span>${t.emoji} ${t.name}</span><b style="color:var(--primary); font-size:16px;">x${t.qty}</b></div>`; has = true; } });
        document.getElementById('sumBox').innerHTML = has ? h : '<p style="text-align:center; color:#94a3b8;">á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á§á”á€ášááŸááŸ’ášá¼áœá”á¶á“á€ááŸ‹ááŸ’ášá¶</p>';
    }

    async function send() {
        let g = db[curI], msg = `ğŸ—ï¸ *ášá”á¶á™á€á¶ášááŸá‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á§á”á€ášááŸ*\nğŸ‘· *á€áŸ’ášá»á˜:* ${g.name}\n\n`;
        let count = 0;
        g.tools.forEach(t => { if(t.qty > 0) { msg += `${t.emoji} ${t.name}: *${t.qty}*\n`; count++; } });
        if(count === 0) return alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á…áŸ†á“á½á“á§á”á€ášááŸ!");
        document.getElementById('loader').style.display = 'flex';
        try {
            await Promise.all([ fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${G_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`), fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${A_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`) ]);
            alert("âœ… á•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸá‡áŸ„á‚á‡áŸá™!");
        } catch(e) { alert("âŒ á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾!"); }
        document.getElementById('loader').style.display = 'none';
    }

    function delG() { if(confirm("áá¾á¢áŸ’á“á€á…á„áŸ‹á›á»á”á€áŸ’ášá»á˜á“áŸáŸ‡á…áŸá‰á˜áŸ‚á“á‘áŸ?")) { db.splice(curI, 1); save(); closeM(); } }
    function closeM() { document.getElementById('mApp').style.display = "none"; curI = null; }
</script>
</body>
    </html>
    
